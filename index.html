<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Averta Project Explorer v4</title>
<script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
<script crossorigin src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.js"></script>
<script>
if (typeof Recharts === 'undefined') {
  document.write('<script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"><\/script>');
}
</script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #0f1117; color: #e2e4e9; margin: 0; }
  .slider-track { -webkit-appearance: none; appearance: none; height: 4px; background: #2a2d35; border-radius: 2px; outline: none; width: 100%; }
  .slider-track::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #f59e0b; cursor: pointer; }
  .slider-track::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: #f59e0b; cursor: pointer; border: none; }
  .panel { background: #1a1d24; border: 1px solid #2a2d35; border-radius: 8px; }
  .confidence-high { color: #22c55e; }
  .confidence-medium { color: #f59e0b; }
  .confidence-low { color: #ef4444; }
</style>
</head>
<body>
<div id="root"></div>
<script>
(function() {
  var missing = [];
  if (typeof React === 'undefined') missing.push('React');
  if (typeof ReactDOM === 'undefined') missing.push('ReactDOM');
  if (typeof Recharts === 'undefined') missing.push('Recharts');
  if (missing.length > 0) {
    document.getElementById('root').innerHTML =
      '<div style="padding:40px;color:#ef4444;font-family:monospace;background:#1a1d24;border-radius:8px;margin:20px;">' +
      '<h2 style="color:#f59e0b;">Averta Explorer v4 — Dependency Error</h2>' +
      '<p>Failed to load: <strong>' + missing.join(', ') + '</strong></p></div>';
  }
})();
</script>
<script>
const D = {"metadata":{"version":"0.3.0","build_date":"2026-02-15T11:19:24.693195","build_script":"build_explorer_data.py","plants_actual":["pandrol","alfe"],"synthetic_zones":6,"reference_kwp":124.12,"model_horizon_years":25,"currency":"EUR","price_base_year":2026,"notes":"Post-Robert corrections: mix→1/99, surplus→€0.045, 2.0TD market energy calibrated. 3.0TD market energy still provisional. Mecanizados data pending.","v3_features":["monte_carlo","risk_register","sensitivity","portfolio"]},"production":{"actuals":{"pandrol_2025":{"plant":"pandrol","year":2025,"kwp":196.35,"annual_kwh":192336.0,"specific_yield":979.6,"performance_ratio":0.834,"monthly_kwh_per_kwp":[38.7176,61.8161,81.1225,101.0278,117.5045,120.5567,108.1278,109.8635,91.4057,75.6389,40.1187,33.6557],"monthly_kwh_total":[7602.0,12138.0,15928.0,19837.0,23072.0,23671.0,21231.0,21572.0,17948.0,14852.0,7877.0,6608.0],"seasonal_hourly_shape":{"winter":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.001,0.0202,0.073,0.124,0.1687,0.1889,0.1778,0.1354,0.0796,0.0277,0.0037,0.0,0.0,0.0,0.0,0.0],"spring":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0012,0.0128,0.0446,0.0813,0.1148,0.1237,0.1248,0.1165,0.1177,0.1017,0.0794,0.0511,0.0235,0.0064,0.0006,0.0,0.0],"summer":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0022,0.0145,0.0404,0.0718,0.093,0.1102,0.119,0.1187,0.1169,0.1072,0.0883,0.0662,0.0362,0.0131,0.0024,0.0,0.0],"autumn":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0028,0.0261,0.0728,0.1232,0.1489,0.1543,0.1451,0.1252,0.1008,0.0635,0.0287,0.0078,0.0008,0.0,0.0,0.0]},"daily_stats":{"mean_daily_kwh":526.9,"std_daily_kwh":313.1,"cv":0.594,"monthly_cv":[0.58,0.406,0.465,0.452,0.397,0.461,0.435,0.439,0.339,0.416,0.57,0.634]},"production_hours":4563,"peak_hourly_kwh":148.2,"peak_hourly_kwh_per_kwp":0.755},"alfe_2024":{"plant":"alfe","year":2024,"kwp":500.0,"annual_kwh":353223.0,"specific_yield":706.4,"performance_ratio":0.601,"monthly_kwh_per_kwp":[32.812,34.2308,65.5562,69.1422,93.2816,82.8732,92.9192,61.8516,61.0728,51.1154,36.744,24.0992],"monthly_kwh_total":[16406.0,17115.0,32778.0,34571.0,46641.0,41437.0,46460.0,30926.0,30536.0,25558.0,18372.0,12050.0],"seasonal_hourly_shape":{"winter":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0006,0.0206,0.084,0.1416,0.1742,0.1709,0.1529,0.1232,0.0901,0.0363,0.0055,0.0,0.0,0.0,0.0,0.0],"spring":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0014,0.0138,0.0531,0.094,0.1183,0.1294,0.121,0.1086,0.1012,0.092,0.0745,0.0509,0.0286,0.0118,0.0014,0.0,0.0],"summer":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0025,0.0186,0.0526,0.0821,0.1054,0.1148,0.1089,0.1045,0.1011,0.0941,0.0826,0.0624,0.0447,0.0212,0.0046,0.0001,0.0],"autumn":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0026,0.0272,0.0776,0.1234,0.1459,0.1481,0.1418,0.1257,0.0972,0.0635,0.0339,0.0121,0.001,0.0,0.0,0.0]},"daily_stats":{"mean_daily_kwh":965.1,"std_daily_kwh":624.5,"cv":0.647,"monthly_cv":[0.46,0.474,0.487,0.483,0.52,0.567,0.47,0.449,0.427,0.469,0.384,0.502]},"production_hours":4606,"peak_hourly_kwh":361.9,"peak_hourly_kwh_per_kwp":0.724},"alfe_2025":{"plant":"alfe","year":2025,"kwp":500.0,"annual_kwh":331734.0,"specific_yield":663.5,"performance_ratio":0.565,"monthly_kwh_per_kwp":[27.4536,36.211,55.2114,70.9736,79.1698,86.1024,72.44,62.6114,59.1518,60.0906,29.893,24.1594],"monthly_kwh_total":[13727.0,18105.0,27606.0,35487.0,39585.0,43051.0,36220.0,31306.0,29576.0,30045.0,14947.0,12080.0],"seasonal_hourly_shape":{"winter":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0011,0.0206,0.0781,0.1321,0.1685,0.1732,0.1603,0.1331,0.0894,0.0376,0.0058,0.0001,0.0,0.0,0.0,0.0],"spring":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0013,0.0154,0.0519,0.0879,0.1101,0.1219,0.1174,0.1122,0.1087,0.094,0.0756,0.0572,0.0327,0.0121,0.0014,0.0002,0.0],"summer":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0025,0.0196,0.0537,0.0784,0.0988,0.1114,0.1073,0.1063,0.1026,0.0908,0.0836,0.0673,0.0475,0.0248,0.0053,0.0001,0.0],"autumn":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0027,0.0284,0.0818,0.1232,0.1504,0.1517,0.1342,0.1182,0.0963,0.0646,0.0356,0.0115,0.0014,0.0,0.0,0.0]},"daily_stats":{"mean_daily_kwh":908.9,"std_daily_kwh":602.7,"cv":0.663,"monthly_cv":[0.541,0.627,0.502,0.589,0.536,0.516,0.523,0.563,0.417,0.437,0.483,0.449]},"production_hours":4577,"peak_hourly_kwh":338.6,"peak_hourly_kwh_per_kwp":0.677}},"synthetic_zones":{"atlantico":{"name":"Atlántico (Vigo/Galicia)","lat":42.24,"lon":-8.72,"altitude":20,"annual_yield_per_kwp":1290.0,"monthly_kwh_per_kwp":[62.0,78.0,108.0,125.0,142.0,148.0,155.0,145.0,118.0,92.0,65.0,52.0],"seasonal_hourly_shape":{"winter":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0117,0.04,0.0898,0.1548,0.2037,0.2037,0.1548,0.0898,0.04,0.0117,0.0,0.0,0.0,0.0,0.0,0.0,0.0],"spring":[0.0,0.0,0.0,0.0,0.0,0.0059,0.0175,0.0354,0.0628,0.0971,0.1303,0.1511,0.1511,0.1303,0.0971,0.0628,0.0354,0.0175,0.0059,0.0,0.0,0.0,0.0,0.0],"summer":[0.0,0.0,0.0,0.0,0.0017,0.0112,0.023,0.0416,0.067,0.0959,0.122,0.1376,0.1376,0.122,0.0959,0.067,0.0416,0.023,0.0112,0.0017,0.0,0.0,0.0,0.0],"autumn":[0.0,0.0,0.0,0.0,0.0,0.0,0.0068,0.0234,0.0516,0.0952,0.1445,0.1785,0.1785,0.1445,0.0952,0.0516,0.0234,0.0068,0.0,0.0,0.0,0.0,0.0,0.0]},"production_hours":4380,"eff_rate_2td":0.153254,"eff_rate_3td":0.109279,"sw_market_2td":0.121959,"sw_market_3td":0.10241,"raw_yield_per_kwp":1290.0,"adjusted_yield_per_kwp":1096,"pvgis_adjustment_factor":0.85},"cantabrico":{"name":"Cantábrico (Irún/Basque)","lat":43.34,"lon":-1.79,"altitude":15,"annual_yield_per_kwp":1175.0,"monthly_kwh_per_kwp":[55.0,70.0,100.0,115.0,130.0,135.0,140.0,130.0,110.0,85.0,60.0,45.0],"seasonal_hourly_shape":{"winter":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0101,0.0392,0.0892,0.1556,0.2059,0.2059,0.1556,0.0892,0.0392,0.0101,0.0,0.0,0.0,0.0,0.0,0.0,0.0],"spring":[0.0,0.0,0.0,0.0,0.0,0.0061,0.0176,0.0356,0.0629,0.097,0.13,0.1507,0.1507,0.13,0.097,0.0629,0.0356,0.0176,0.0061,0.0,0.0,0.0,0.0,0.0],"summer":[0.0,0.0,0.0,0.0,0.0028,0.0116,0.0234,0.0419,0.0671,0.0956,0.1212,0.1364,0.1364,0.1212,0.0956,0.0671,0.0419,0.0234,0.0116,0.0028,0.0,0.0,0.0,0.0],"autumn":[0.0,0.0,0.0,0.0,0.0,0.0,0.0068,0.0232,0.0513,0.0949,0.1446,0.1791,0.1791,0.1446,0.0949,0.0513,0.0232,0.0068,0.0,0.0,0.0,0.0,0.0,0.0]},"production_hours":4380,"eff_rate_2td":0.153243,"eff_rate_3td":0.109172,"sw_market_2td":0.121957,"sw_market_3td":0.102408,"raw_yield_per_kwp":1175.0,"adjusted_yield_per_kwp":999,"pvgis_adjustment_factor":0.85},"mediterraneo":{"name":"Mediterráneo (Barcelona/Costa)","lat":41.39,"lon":2.17,"altitude":80,"annual_yield_per_kwp":1585.0,"monthly_kwh_per_kwp":[85.0,100.0,135.0,150.0,165.0,175.0,180.0,170.0,145.0,115.0,90.0,75.0],"seasonal_hourly_shape":{"winter":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0141,0.0403,0.0898,0.1539,0.2019,0.2019,0.1539,0.0898,0.0403,0.0141,0.0,0.0,0.0,0.0,0.0,0.0,0.0],"spring":[0.0,0.0,0.0,0.0,0.0,0.0056,0.0173,0.0351,0.0625,0.0971,0.1307,0.1517,0.1517,0.1307,0.0971,0.0625,0.0351,0.0173,0.0056,0.0,0.0,0.0,0.0,0.0],"summer":[0.0,0.0,0.0,0.0,0.0,0.011,0.0227,0.0414,0.067,0.0964,0.1228,0.1386,0.1386,0.1228,0.0964,0.067,0.0414,0.0227,0.011,0.0,0.0,0.0,0.0,0.0],"autumn":[0.0,0.0,0.0,0.0,0.0,0.0,0.0066,0.0233,0.0515,0.0952,0.1446,0.1788,0.1788,0.1446,0.0952,0.0515,0.0233,0.0066,0.0,0.0,0.0,0.0,0.0,0.0]},"production_hours":4380,"eff_rate_2td":0.153461,"eff_rate_3td":0.109622,"sw_market_2td":0.122,"sw_market_3td":0.102454,"raw_yield_per_kwp":1585.0,"adjusted_yield_per_kwp":1347,"pvgis_adjustment_factor":0.85},"meseta":{"name":"Meseta (Madrid/Central)","lat":40.42,"lon":-3.7,"altitude":650,"annual_yield_per_kwp":1635.0,"monthly_kwh_per_kwp":[85.0,100.0,140.0,150.0,170.0,185.0,195.0,185.0,155.0,115.0,85.0,70.0],"seasonal_hourly_shape":{"winter":[0.0,0.0,0.0,0.0,0.0,0.0,0.0001,0.0147,0.0412,0.0904,0.1534,0.2001,0.2001,0.1534,0.0904,0.0412,0.0147,0.0001,0.0,0.0,0.0,0.0,0.0,0.0],"spring":[0.0,0.0,0.0,0.0,0.0,0.0054,0.0171,0.0349,0.0624,0.0971,0.1309,0.1521,0.1521,0.1309,0.0971,0.0624,0.0349,0.0171,0.0054,0.0,0.0,0.0,0.0,0.0],"summer":[0.0,0.0,0.0,0.0,0.0,0.0107,0.0223,0.041,0.0668,0.0965,0.1233,0.1394,0.1394,0.1233,0.0965,0.0668,0.041,0.0223,0.0107,0.0,0.0,0.0,0.0,0.0],"autumn":[0.0,0.0,0.0,0.0,0.0,0.0,0.007,0.0238,0.0522,0.0955,0.1441,0.1775,0.1775,0.1441,0.0955,0.0522,0.0238,0.007,0.0,0.0,0.0,0.0,0.0,0.0]},"production_hours":4380,"eff_rate_2td":0.153347,"eff_rate_3td":0.109542,"sw_market_2td":0.121976,"sw_market_3td":0.102462,"raw_yield_per_kwp":1635.0,"adjusted_yield_per_kwp":1390,"pvgis_adjustment_factor":0.85},"sur":{"name":"Sur (Sevilla/Andalucía)","lat":37.39,"lon":-5.98,"altitude":30,"annual_yield_per_kwp":1890.0,"monthly_kwh_per_kwp":[105.0,115.0,160.0,170.0,195.0,210.0,220.0,210.0,175.0,135.0,105.0,90.0],"seasonal_hourly_shape":{"winter":[0.0,0.0,0.0,0.0,0.0,0.0,0.0003,0.016,0.0433,0.0919,0.1523,0.1962,0.1962,0.1523,0.0919,0.0433,0.016,0.0003,0.0,0.0,0.0,0.0,0.0,0.0],"spring":[0.0,0.0,0.0,0.0,0.0,0.0049,0.0166,0.0343,0.0621,0.0973,0.1316,0.1532,0.1532,0.1316,0.0973,0.0621,0.0343,0.0166,0.0049,0.0,0.0,0.0,0.0,0.0],"summer":[0.0,0.0,0.0,0.0,0.0,0.0097,0.0213,0.0399,0.0662,0.0967,0.1247,0.1415,0.1415,0.1247,0.0967,0.0662,0.0399,0.0213,0.0097,0.0,0.0,0.0,0.0,0.0],"autumn":[0.0,0.0,0.0,0.0,0.0,0.0,0.007,0.0241,0.0527,0.0959,0.1438,0.1764,0.1764,0.1438,0.0959,0.0527,0.0241,0.007,0.0,0.0,0.0,0.0,0.0,0.0]},"production_hours":4380,"eff_rate_2td":0.153461,"eff_rate_3td":0.109708,"sw_market_2td":0.121998,"sw_market_3td":0.102481,"raw_yield_per_kwp":1890.0,"adjusted_yield_per_kwp":1606,"pvgis_adjustment_factor":0.85},"sureste":{"name":"Sureste (Murcia/Almería)","lat":37.98,"lon":-1.13,"altitude":40,"annual_yield_per_kwp":1925.0,"monthly_kwh_per_kwp":[108.0,118.0,158.0,172.0,198.0,215.0,225.0,215.0,178.0,138.0,108.0,92.0],"seasonal_hourly_shape":{"winter":[0.0,0.0,0.0,0.0,0.0,0.0,0.0003,0.0157,0.0428,0.0916,0.1525,0.197,0.197,0.1525,0.0916,0.0428,0.0157,0.0003,0.0,0.0,0.0,0.0,0.0,0.0],"spring":[0.0,0.0,0.0,0.0,0.0,0.005,0.0167,0.0345,0.0622,0.0973,0.1314,0.1529,0.1529,0.1314,0.0973,0.0622,0.0345,0.0167,0.005,0.0,0.0,0.0,0.0,0.0],"summer":[0.0,0.0,0.0,0.0,0.0,0.0099,0.0215,0.0401,0.0663,0.0967,0.1244,0.1411,0.1411,0.1244,0.0967,0.0663,0.0401,0.0215,0.0099,0.0,0.0,0.0,0.0,0.0],"autumn":[0.0,0.0,0.0,0.0,0.0,0.0,0.0069,0.024,0.0525,0.0958,0.1439,0.1768,0.1768,0.1439,0.0958,0.0525,0.024,0.0069,0.0,0.0,0.0,0.0,0.0,0.0]},"production_hours":4380,"eff_rate_2td":0.153463,"eff_rate_3td":0.109724,"sw_market_2td":0.121999,"sw_market_3td":0.102473,"raw_yield_per_kwp":1925.0,"adjusted_yield_per_kwp":1636,"pvgis_adjustment_factor":0.85}},"reference":{"excel_model_specific_yield":1522.72,"pvgis_irun":1175,"pvgis_eibar":1140,"pvgis_barcelona":1585,"pvgis_madrid":1635,"pvgis_sevilla":1890,"pvgis_murcia":1925}},"sumproduct":{"pandrol":{"20TD":{"kwh_by_period":[45192.2,40412.7,35977.5],"pct_by_period":[0.3717,0.3324,0.2959],"revenue_by_period":[7408.22,4249.16,3046.96],"effective_rate":0.1512,"total_revenue_autoconsumo":14704.34,"total_revenue_surplus":1094.24,"total_revenue":15798.58,"total_production_kwh":121582.0,"autoconsumo_ratio":0.8},"30TD":{"kwh_by_period":[8728.6,16810.0,17758.2,27117.8,15190.3,35977.5],"pct_by_period":[0.0718,0.1383,0.1461,0.223,0.1249,0.2959],"revenue_by_period":[1017.05,1827.94,1633.57,2227.48,1164.19,2639.7],"effective_rate":0.1081,"total_revenue_autoconsumo":10509.93,"total_revenue_surplus":1094.24,"total_revenue":11604.17,"total_production_kwh":121582.0,"autoconsumo_ratio":0.8}},"alfe":{"20TD":{"kwh_by_period":[37213.2,31461.4,13675.0],"pct_by_period":[0.4519,0.382,0.1661],"revenue_by_period":[6100.24,3307.99,1158.15],"effective_rate":0.1604,"total_revenue_autoconsumo":10566.38,"total_revenue_surplus":741.15,"total_revenue":11307.53,"total_production_kwh":82350.0,"autoconsumo_ratio":0.8},"30TD":{"kwh_by_period":[7048.6,12888.5,14853.7,21473.1,12410.7,13675.0],"pct_by_period":[0.0856,0.1565,0.1804,0.2608,0.1507,0.1661],"revenue_by_period":[821.29,1401.52,1366.39,1763.81,951.15,1003.35],"effective_rate":0.1109,"total_revenue_autoconsumo":7307.51,"total_revenue_surplus":741.15,"total_revenue":8048.66,"total_production_kwh":82350.0,"autoconsumo_ratio":0.8}}},"tariff":{"calendar_summary":{"20TD":{"hours_per_period":[2032,2032,4696],"solar_hours_per_period":[1623,1471,1469],"labels":["Punta","Llano","Valle"]},"30TD":{"hours_per_period":[680,923,791,961,455,4950],"solar_hours_per_period":[470,685,715,846,378,1469],"labels":["P1 (punta)","P2","P3","P4","P5","P6 (valle)"]}},"prices_2026":{"20TD":{"peaje":[0.033773,0.01654,7.9e-05],"cargo":[0.067296,0.014084,0.002466],"market":[0.132,0.116,0.114],"retail":[0.2411,0.1546,0.1245],"averta":[0.2049,0.1314,0.1059]},"30TD":{"peaje":[0.027511,0.012376,0.004943,0.002627,0.000111,3.1e-05],"cargo":[0.035841,0.026538,0.014336,0.007168,0.004595,0.002867],"market":[0.1,0.113,0.108,0.103,0.1,0.097],"retail":[0.1714,0.1599,0.1353,0.1208,0.1127,0.1079],"averta":[0.1456,0.1359,0.115,0.1027,0.0958,0.0917]}},"discount_factor":0.85},"irr_grid":{"description":"Pre-computed unlevered IRR at grid intersections for slider interpolation","axes":{"specific_yield":[600,800,1000,1200,1522],"tariff_mix_2td":[0.0,0.05,0.1,0.25,0.5],"autoconsumo_ratio":[0.5,0.65,0.8,0.9,0.98]},"equity_share":1.0,"capex_per_kwp":604.25,"eff_rate_3td":0.10805343133872616,"eff_rate_2td":0.15117667841694465,"sw_market_3td":0.10274723718167611,"sw_market_2td":0.12135538006583467,"irr_values":[[[-0.086222,-0.044797,-0.017514,-0.004214,0.004721],[-0.086222,-0.044797,-0.017514,-0.004214,0.004721],[-0.086222,-0.044797,-0.017514,-0.004214,0.004721],[-0.086222,-0.044797,-0.017514,-0.004214,0.004721],[-0.086222,-0.044797,-0.017514,-0.004214,0.004721]],[[-0.004218,0.0163,0.033546,0.044049,0.052015],[-0.004218,0.0163,0.033546,0.044049,0.052015],[-0.004218,0.0163,0.033546,0.044049,0.052015],[-0.004218,0.0163,0.033546,0.044049,0.052015],[-0.004218,0.0163,0.033546,0.044049,0.052015]],[[0.033543,0.052742,0.07017,0.081083,0.089494],[0.033543,0.052742,0.07017,0.081083,0.089494],[0.033543,0.052742,0.07017,0.081083,0.089494],[0.033543,0.052742,0.07017,0.081083,0.089494],[0.033543,0.052742,0.07017,0.081083,0.089494]],[[0.063368,0.083208,0.101674,0.113429,0.122583],[0.063368,0.083208,0.101674,0.113429,0.122583],[0.063368,0.083208,0.101674,0.113429,0.122583],[0.063368,0.083208,0.101674,0.113429,0.122583],[0.063368,0.083208,0.101674,0.113429,0.122583]],[[0.10429,0.126215,0.147139,0.160686,0.171345],[0.10429,0.126215,0.147139,0.160686,0.171345],[0.10429,0.126215,0.147139,0.160686,0.171345],[0.10429,0.126215,0.147139,0.160686,0.171345],[0.10429,0.126215,0.147139,0.160686,0.171345]]],"notes":"All other parameters at registry defaults. Unlevered (100% equity). irr_values[yield_idx][mix_idx][autoconsumo_idx]."},"waterfall":{"baseline_excel":{"label":"Excel model (blended, 1523 kWh/kWp)","irr":0.1472,"description":"Starting point: Excel model assumptions"},"yield_correction":{"label":"Yield → 980 kWh/kWp (Pandrol actual)","irr":0.0668},"price_correction":{"label":"Price → sumproduct (~1/99 mix)","irr":0.0668},"worst_tariff_mix":{"label":"100% 3.0TD (≈ confirmed mix)","irr":0.0668},"best_tariff_mix":{"label":"100% 2.0TD (hypothetical)","irr":0.0668},"autoconsumo_50":{"label":"Autoconsumo → 50%","irr":0.0303},"autoconsumo_65":{"label":"Autoconsumo → 65%","irr":0.0494},"autoconsumo_98":{"label":"Autoconsumo → 98%","irr":0.086},"default_3pct":{"label":"Consumer default → 3%","irr":0.0617},"default_5pct":{"label":"Consumer default → 5%","irr":0.0583},"default_10pct":{"label":"Consumer default → 10%","irr":0.0494}},"parameters":[{"id":"P-001","key":"kwp_installed","name":"Installed capacity","unit":"kWp","source":"Averta Excel model — Ejemplo 100 kW v2.86","confidence":"high","sensitivity":"medium","layer":"L1","scope":"project","explorer_role":"display","panels":[1],"value":124.12,"description":"Nameplate DC capacity of PV plant","notes":"Standardized ~100 kW nominal. Actual sizing per rooftop."},{"id":"P-002","key":"specific_yield","name":"Specific yield (P50)","unit":"kWh/kWp/year","source":"Mediterráneo adjusted (PVGIS Barcelona 1585 × 0.85 PVGIS adj). Sigma = 5% interannual (literature)","confidence":"medium","sensitivity":"high","layer":"L1","scope":"project","explorer_role":"slider","panels":[1,2,3],"value":1347.0,"description":"Annual energy production per kWp installed — P50 estimate","notes":"Interannual irradiance variability in Spain typically 3-5% (σ/μ). Using 5% as conservative estimate. Operational data shows 6-12% underperformance vs projections — may indicate systematic bias in projections rather than just interannual variability. P90 yield ≈ mu - 1.28*sigma ≈ 1425 kWh/kWp.\n"},{"id":"P-003","key":"degradation_rate","name":"Annual degradation rate","unit":"%/year","source":"Averta Excel model (0.35%/yr). Industry range 0.3-0.7% for mono-Si","confidence":"medium","sensitivity":"low","layer":"L1","scope":"project","explorer_role":"display","panels":[3],"value":0.0035,"description":"Year-over-year production decline from panel aging","notes":"Low single-year impact but compounds over 25 years. Year 25 at 0.35%: 91.7% of year 1."},{"id":"P-010","key":"autoconsumo_ratio","name":"Self-consumption ratio","unit":"ratio","source":"Robert call 2026-02-11: 'un 80 es el que conseguimos real.' Target 90%, actual ~80%. Confirmed.","confidence":"high","sensitivity":"high","layer":"L3","scope":"project","explorer_role":"slider","panels":[2,3],"value":0.8,"description":"Fraction of production consumed by community members (not injected as surplus)","notes":"THIS IS A CRITICAL ASSUMPTION. The 80% is aspirational for a well-matched community. In practice it depends on: number of subscribers, their consumption profiles, occupancy rate, business hours overlap with solar production. Should be calibrated from operational data when available. Beta distribution bounded [0,1] with mode near 0.80.\n"},{"id":"P-011","key":"consumer_occupancy_rate","name":"Consumer occupancy rate","unit":"ratio","source":"Assumption — no operational data on churn rates yet","confidence":"low","sensitivity":"high","layer":"L3","scope":"project","explorer_role":"display","panels":[2],"value":0.9,"description":"Fraction of community slots filled with paying consumers at any time","notes":"Occupancy < 100% means some solar production has no buyer → becomes surplus (valued at pool price, much lower than PPA discount revenue). Churn risk is the #2 driver after production in the sensitivity analysis.\n"},{"id":"P-020","key":"discount_factor","name":"Averta discount factor (Fórmula Indexada)","unit":"ratio","source":"Oferta venta energía 06.02.2026: 15% direct + 5.11% electricity tax = 20.11%","confidence":"high","sensitivity":"high","layer":"L4","scope":"portfolio","explorer_role":"display","panels":[2],"value":0.7989,"description":"Multiplier applied to consumer's retail tariff. 1 - 20.11% = 0.7989","notes":"This is the core commercial proposition. Fixed by contract for contract duration. Revenue per kWh = consumer's retail rate × 0.7989. If Averta changes this to attract consumers, it directly impacts margin.\n"},{"id":"P-024","key":"pool_compensation_price","name":"Compensación simplificada rate","unit":"EUR/kWh","source":"Robert call 2026-02-11: 'entre 40 y 50 €/MWh'. Comercializadora negotiated rate.","confidence":"medium","sensitivity":"medium","layer":"L4","scope":"market","explorer_role":"slider","panels":[2,3],"value":0.045,"description":"Comercializadora rate for surplus kWh under compensación simplificada (RD 244/2019 art. 14)","notes":"NOT a pool sale. Compensación simplificada: comercializadora compensates consumer for excedentes at a negotiated rate (~€40-50/MWh). Exempt from impuesto eléctrico (5.11%) and peaje de generación (€0.5/MWh). Monthly cap: compensation cannot exceed consumed-from-grid value (bill floor = €0 on energy term). RD 244/2019 art. 14. Averta nets this compensation against its discount (exact mechanism pending Elecsum).\n"},{"id":"P-025","key":"ppa_price_base","name":"PPA price (blended, from Excel model)","unit":"EUR/MWh","source":"Averta Excel model — Ejemplo 100 kW v2.86","confidence":"medium","sensitivity":"high","layer":"L4","scope":"project","explorer_role":"display","panels":[2],"value":70.0,"description":"Blended PPA price used in Averta's simplified model","notes":"THIS IS THE SIMPLIFIED MODEL'S APPROXIMATION. In the correct model, revenue = Σ(kWh_period × tariff_period × 0.7989). The €70/MWh is the result of that calculation for a particular consumer mix and tariff structure. We keep it here for validation against the Excel model, then replace with the sumproduct approach when hourly data is available.\n"},{"id":"P-040","key":"consumer_default_rate","name":"Annual consumer payment default rate","unit":"%/year","source":"Assumption. Spanish SME payment delinquency ~2-5%.","confidence":"low","sensitivity":"medium","layer":"L4","scope":"project","explorer_role":"slider","panels":[3],"value":0.03,"description":"Fraction of billed revenue not collected due to non-payment","notes":"Different from churn. Default = consumer exists but doesn't pay. SEPA direct debit reduces this risk. Contract allows service suspension. Multi-offtaker structure means single default is small % of revenue.\n"},{"id":"P-050","key":"capex_per_kwp","name":"All-in CAPEX per kWp","unit":"EUR/kWp","source":"Averta Excel model (€75,000 / 124.12 kWp = €604.25/kWp)","confidence":"medium","sensitivity":"medium","layer":"L5","scope":"project","explorer_role":"display","panels":[3],"value":604.25,"description":"Total installed cost including EPC, permits, connection","notes":"AACE Class 3 (budget/feasibility): -20% to +30%. Range: €483 to €786/kWp. Industry benchmark for C&I rooftop Spain 2025-2026: €500-700/kWp all-in.\n"},{"id":"P-060","key":"equity_share","name":"Equity share of CAPEX","unit":"ratio","source":"Equity-only assumption for initial model","confidence":"high","sensitivity":"pending","layer":"L6","scope":"project","explorer_role":"toggle","panels":[3],"value":1.0,"description":"Fraction of CAPEX funded by equity","notes":"Set to 1.0 (all equity). Override when debt module is built."},{"id":"P-090","key":"consumer_tariff_mix_2td","name":"Consumer tariff mix (% on 2.0TD)","value":0.01,"unit":"fraction","source":"Robert call 2026-02-11: '<1% are 2.0TD, all industry/services'","confidence":"high","sensitivity":"low","layer":"L3","scope":"project","explorer_role":"slider","panels":[2,3],"description":"Fraction of AC consumers on 2.0TD tariff (rest on 3.0TD). Confirmed ~1%."},{"id":"P-092","key":"eff_rate_3td_sumproduct","name":"Effective Averta rate 3.0TD","value":0.0621,"unit":"EUR/kWh","source":"Computed: Pandrol production × 2026 tariffs","confidence":"high","sensitivity":"high","layer":"L4","scope":"project","explorer_role":"display","panels":[2]},{"id":"P-093","key":"eff_rate_2td_sumproduct","name":"Effective Averta rate 2.0TD","value":0.0981,"unit":"EUR/kWh","source":"Computed: Pandrol production × 2026 tariffs","confidence":"high","sensitivity":"high","layer":"L4","scope":"project","explorer_role":"display","panels":[2]},{"id":"P-094","key":"daily_production_cv","name":"Daily production CV","value":0.465,"unit":"ratio","source":"Computed: Pandrol 2025 actual","confidence":"medium","sensitivity":"low","layer":"L1","scope":"project","explorer_role":"display","panels":[1]},{"id":"P-096","key":"rooftop_owner_energy_pct","name":"Rooftop owner energy allocation","value":0.0,"unit":"fraction","source":"Claude assumption — contract terms unknown","confidence":"low","sensitivity":"medium","layer":"L4","scope":"project","explorer_role":"display","panels":[3]}],"sumproduct_detail":{"period_maps":{"20TD":{"workday":[3,3,3,3,3,3,3,3,2,2,1,1,1,1,2,2,2,2,1,1,1,1,2,2],"weekend":[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]},"30TD":{"alta":[6,6,6,6,6,6,6,6,2,1,1,1,1,2,2,2,2,2,1,1,1,1,2,6],"media_alta":[6,6,6,6,6,6,6,6,3,2,2,2,2,3,3,3,3,3,2,2,2,2,3,6],"media":[6,6,6,6,6,6,6,6,4,3,3,3,3,4,4,4,4,4,3,3,3,3,4,6],"baja":[6,6,6,6,6,6,6,6,5,4,4,4,4,5,5,5,5,5,4,4,4,4,5,6],"weekend":[6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6]}},"season_months":{"alta":[1,2,7,12],"media_alta":[3,11],"media":[6,8,9],"baja":[4,5,10]},"production_shape_by_tariff_season":{"alta":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.001,0.0074,0.0301,0.0718,0.1064,0.1421,0.1554,0.1512,0.1245,0.0895,0.0565,0.0356,0.0193,0.0077,0.0015,0.0,0.0],"media_alta":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0002,0.0099,0.0443,0.0956,0.1377,0.1562,0.1592,0.145,0.1164,0.0775,0.0403,0.0143,0.003,0.0003,0.0,0.0,0.0],"media":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0016,0.011,0.0354,0.0706,0.1026,0.1185,0.1246,0.1221,0.122,0.1106,0.0867,0.0568,0.0278,0.0084,0.0014,0.0,0.0],"baja":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0011,0.0099,0.0377,0.0743,0.1106,0.1235,0.129,0.1206,0.1203,0.1076,0.0819,0.0527,0.0236,0.0064,0.0006,0.0,0.0]},"rate_comparison":{"flat_profile_2td":0.1348,"flat_profile_3td":0.1041,"solar_weighted_2td":0.1512,"solar_weighted_3td":0.1081,"solar_vs_flat_penalty_2td":12.2,"solar_vs_flat_penalty_3td":3.8,"notes":"Flat = uniform production all 8760 hours. Solar = actual Pandrol hourly profile. Penalty shows how solar concentration in low-tariff periods reduces effective rate."}},"pnl_25yr":{"reference_case":{"specific_yield":980,"tariff_mix_2td":0.01,"autoconsumo_ratio":0.8,"surplus_compensation_price":0.045,"eff_rate":0.1085,"eff_rate_2td":0.1512,"eff_rate_3td":0.1081,"sw_market_2td":0.121355,"sw_market_3td":0.102747,"ppa_price_base":108.5,"equity_share":1.0,"capex_per_kwp":604.25},"years":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],"production_kwh":[121638.0,121212.0,120788.0,120365.0,119944.0,119524.0,119105.0,118689.0,118273.0,117859.0,117447.0,117036.0,116626.0,116218.0,115811.0,115406.0,115002.0,114599.0,114198.0,113799.0,113400.0,113003.0,112608.0,112214.0,111821.0],"revenue_ppa":[10556.65,10730.1,10906.39,11085.58,11267.72,11452.85,11641.02,11832.28,12026.69,12224.28,12425.13,12629.27,12836.77,13047.68,13262.05,13479.95,13701.43,13926.54,14155.35,14387.93,14624.32,14864.6,15108.82,15357.06,15609.38],"revenue_surplus":[1094.74,1112.72,1131.01,1149.59,1168.48,1187.68,1207.19,1227.02,1247.18,1267.67,1288.5,1309.67,1331.19,1353.06,1375.29,1397.89,1420.86,1444.2,1467.93,1492.05,1516.56,1541.48,1566.8,1592.55,1618.71],"revenue_total":[11730.27,11923.0,12118.89,12318.01,12520.39,12726.1,12935.19,13147.72,13363.73,13583.3,13806.47,14033.31,14263.88,14498.23,14736.44,14978.56,15224.66,15474.8,15729.05,15987.48,16250.15,16517.14,16788.52,17064.36,17344.72],"cost_maintenance":[1489.44,1519.23,1549.61,1580.61,1612.22,1644.46,1677.35,1710.9,1745.12,1780.02,1815.62,1851.93,1888.97,1926.75,1965.28,2004.59,2044.68,2085.58,2127.29,2169.83,2213.23,2257.49,2302.64,2348.7,2395.67],"cost_insurance":[496.48,506.41,516.54,526.87,537.41,548.15,559.12,570.3,581.71,593.34,605.21,617.31,629.66,642.25,655.09,668.2,681.56,695.19,709.1,723.28,737.74,752.5,767.55,782.9,798.56],"cost_rent":[3216.0,3248.16,3280.64,3313.45,3346.58,3380.05,3413.85,3447.99,3482.47,3517.29,3552.46,3587.99,3623.87,3660.11,3696.71,3733.68,3771.01,3808.72,3846.81,3885.28,3924.13,3963.37,4003.01,4043.04,4083.47],"cost_bad_debt":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],"total_opex":[5201.92,5273.8,5346.79,5420.92,5496.21,5572.66,5650.32,5729.19,5809.29,5890.65,5973.29,6057.23,6142.5,6229.11,6317.09,6406.46,6497.26,6589.49,6683.19,6778.39,6875.1,6973.36,7073.2,7174.63,7277.69],"ebitda":[6528.35,6649.2,6772.1,6897.08,7024.18,7153.44,7284.87,7418.53,7554.44,7692.65,7833.18,7976.08,8121.38,8269.13,8419.35,8572.1,8727.4,8885.31,9045.86,9209.09,9375.05,9543.78,9715.32,9889.72,10067.03],"depreciation":[2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98,2999.98],"tax":[882.09,912.3,943.03,974.28,1006.05,1038.36,1071.22,1104.64,1138.62,1173.17,1208.3,1244.03,1280.35,1317.29,1354.84,1393.03,1431.86,1471.33,1511.47,1552.28,1593.77,1635.95,1678.84,1722.44,1766.76],"sustaining_capex":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,7447.2,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],"cfads":[5646.26,5736.89,5829.07,5922.81,6018.13,6115.07,6213.65,6313.89,6415.83,6519.48,6624.88,-715.14,6841.03,6951.84,7064.51,7179.07,7295.55,7413.98,7534.39,7656.81,7781.28,7907.83,8036.49,8167.29,8300.27],"equity_cf":[5646.26,5736.89,5829.07,5922.81,6018.13,6115.07,6213.65,6313.89,6415.83,6519.48,6624.88,-715.14,6841.03,6951.84,7064.51,7179.07,7295.55,7413.98,7534.39,7656.81,7781.28,7907.83,8036.49,8167.29,8300.27],"summary":{"total_capex":75000.0,"equity_investment":75000.0,"irr_unlevered":0.0668,"npv_at_4pct":24528.0,"payback_year":14,"cumulative_cf_25yr":89772.0,"year1_ebitda":6528.0,"year25_ebitda":10067.0},"cumulative_cf":[-75000.0,-69353.0,-63616.0,-57787.0,-51864.0,-45846.0,-39731.0,-33518.0,-27204.0,-20788.0,-14268.0,-7644.0,-8359.0,-1518.0,5434.0,12499.0,19678.0,26973.0,34387.0,41922.0,49578.0,57360.0,65268.0,73304.0,81471.0,89772.0],"escalation":{"retail_tariff":0.02,"opex":0.02,"rent":0.01,"degradation":0.0035}},"monte_carlo":{"n_simulations":500,"seed":42,"irr":{"p10":0.0566,"p25":0.0931,"p50":0.1246,"p75":0.1567,"p90":0.1871,"mean":0.1171,"std":0.0999,"histogram":{"counts":[3,0,0,0,0,0,0,0,0,0,0,0,0,0,2,5,72,223,166,29],"edges":[-0.99,-0.9273,-0.8647,-0.802,-0.7394,-0.6767,-0.6141,-0.5514,-0.4888,-0.4261,-0.3635,-0.3008,-0.2382,-0.1755,-0.1129,-0.0502,0.0124,0.0751,0.1377,0.2004,0.263]}},"npv":{"p10":9605.0,"p50":57936.0,"p90":119518.0},"payback":{"p10":7,"p50":10,"p90":16},"cashflow_fan":{"years":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],"p10":[-42841.0,1923.0,1614.0,925.0,1000.0,841.0,902.0,1016.0,939.0,729.0,916.0,5376.0,-2091.0,5273.0,5256.0,5149.0,5065.0,5015.0,4791.0,4763.0,4689.0,4423.0,4337.0,4312.0,4076.0,3958.0],"p50":[-37504.0,3828.0,3831.0,3804.0,3900.0,3910.0,3908.0,3934.0,4052.0,4037.0,3988.0,8680.0,1206.0,8760.0,8811.0,8649.0,8855.0,8988.0,8781.0,9172.0,9147.0,9206.0,9274.0,9316.0,9427.0,9710.0],"p90":[-32795.0,5230.0,5433.0,5636.0,5908.0,6082.0,6418.0,6865.0,7160.0,7337.0,7658.0,12499.0,5172.0,13442.0,13634.0,14251.0,14895.0,15202.0,15701.0,16330.0,16716.0,17423.0,17859.0,18372.0,18893.0,19446.0]},"probabilities":{"irr_below_0":0.016,"irr_below_4pct":0.06,"irr_above_8pct":0.808},"stochastic_params_used":["specific_yield","degradation_rate","performance_ratio","curtailment_factor","autoconsumo_ratio","consumer_occupancy_rate","annual_churn_rate","churn_replacement_time_months","retail_tariff_escalation","pool_compensation_price","opex_maintenance_per_kwp","opex_escalation","consumer_default_rate","capex_per_kwp"],"events":{"enabled":true,"specs":[{"name":"regulatory_shock","target":"revenue_multiplier","p_annual":0.04,"severity_range":[0.7,0.9],"persistence":"permanent","correlation":"portfolio","risk_id":"R-14"},{"name":"macro_stress","target":"autoconsumo_multiplier","p_annual":0.08,"severity_range":[0.5,0.8],"persistence":"temporary","correlation":"portfolio","risk_id":"R-07"},{"name":"grid_curtailment","target":"curtailment_add","p_annual":0.02,"severity_range":[0.05,0.15],"persistence":"temporary","correlation":"regional","risk_id":"R-12"}],"event_counts":{"regulatory_shock":312,"macro_stress":429,"grid_curtailment":310},"sims_with_any_event":493,"pct_sims_with_event":0.986}},"risk_register":{"total_risks":17,"priced_count":0,"bankability_score":0.1765,"risks":[{"id":"R-01","name":"development","display_name":"Development","description":"Permit rejection, lease falls through, consumers not secured, interconnection denied. Three failure modes (roof, consumers, interconnection) — one risk: we deliver RTB or we don't.\n","category":"pre_cod","type":"managed","correlation":"independent","correlation_rho":0.0,"transmission":[],"mitigation":"Pipeline diversification, standardized process, parallel permitting","status":"acknowledged","evidence_status":"identified"},{"id":"R-02","name":"construction_epc","display_name":"Construction / EPC","description":"Cost overrun, construction delay, quality defects","category":"pre_cod","type":"priceable","correlation":"independent","correlation_rho":0.0,"transmission":["P-050"],"mitigation":"Fixed-price EPC contract, milestone payments (5/30/30/30/5), 2-year defect warranty","status":"acknowledged","evidence_status":"quantified"},{"id":"R-03","name":"stabilization","display_name":"Stabilization","description":"Commissioning failure, initial yield below forecast, connection issues","category":"pre_cod","type":"managed","correlation":"independent","correlation_rho":0.0,"transmission":[],"mitigation":"EPC defect warranty (2-yr), commissioning test protocol, 30-yr module production guarantee","status":"acknowledged","evidence_status":"identified"},{"id":"R-04","name":"production_shortfall","display_name":"Production shortfall (irradiance)","description":"Annual energy output below forecast due to weather variability, soiling, shading","category":"operating","type":"priceable","correlation":"regional","correlation_rho":0.7,"transmission":["P-002"],"mitigation":"Geographic diversification, P90 design, PVGIS-validated forecasts","status":"acknowledged","evidence_status":"evidenced"},{"id":"R-05","name":"equipment_degradation","display_name":"Equipment degradation","description":"Year-over-year production decline exceeding forecast degradation rate","category":"operating","type":"priceable","correlation":"independent","correlation_rho":0.0,"transmission":["P-003"],"mitigation":"Manufacturer 30-yr linear power warranty, module quality selection","status":"acknowledged","evidence_status":"evidenced"},{"id":"R-06","name":"equipment_failure_performance","display_name":"Equipment failure / performance","description":"Inverter failure, module hotspot, wiring fault, performance below spec","category":"operating","type":"priceable","correlation":"independent","correlation_rho":0.0,"transmission":["P-030","P-004"],"mitigation":"5-yr inverter warranty, O&M contract, all-risk insurance","status":"acknowledged","evidence_status":"quantified"},{"id":"R-07","name":"consumer_default_churn","display_name":"Consumer default / churn","description":"Consumer non-payment, business closure, relocation, voluntary switch","category":"operating","type":"priceable","correlation":"partially_correlated","correlation_rho":0.2,"transmission":["P-011","P-012","P-040"],"mitigation":"SEPA direct debit, replacement provision, credit screening, multi-offtaker structure","status":"acknowledged","evidence_status":"quantified"},{"id":"R-08","name":"autoconsumo_ratio_variability","display_name":"Autoconsumo ratio variability","description":"Self-consumption ratio lower than forecast — more surplus, less PPA revenue","category":"operating","type":"priceable","correlation":"partially_correlated","correlation_rho":0.3,"transmission":["P-010"],"mitigation":"Coefficient optimization (Elecsum), consumer mix matching, demand profiling","status":"acknowledged","evidence_status":"quantified"},{"id":"R-09","name":"counterparty_concentration","display_name":"Counterparty concentration","description":"Revenue concentration in few consumers or sectors within a project/portfolio","category":"operating","type":"priceable","correlation":"portfolio_level","correlation_rho":null,"transmission":[],"mitigation":"Minimum consumer count per project, sector diversification, geographic spread","status":"acknowledged","evidence_status":"identified"},{"id":"R-10","name":"rooftop_lease","display_name":"Rooftop / lease","description":"Property sale, building demolition, lease termination, access disputes","category":"operating","type":"priceable","correlation":"independent","correlation_rho":0.0,"transmission":["P-032"],"mitigation":"25-year lease, assignment clause, surface rights option, €1 reversión at end","status":"acknowledged","evidence_status":"quantified"},{"id":"R-11","name":"allocation_settlement","display_name":"Allocation / settlement","description":"Coefficient errors, DSO delays, billing disputes, Elecsum service failures","category":"operating","type":"managed","correlation":"partially_correlated","correlation_rho":0.4,"transmission":[],"mitigation":"Elecsum SLA, coefficient audit process, distribuidora escalation protocol","status":"acknowledged","evidence_status":"identified"},{"id":"R-12","name":"grid_interface","display_name":"Grid / interface","description":"Curtailment, metering errors, grid compliance issues, DSO interaction","category":"operating","type":"managed","correlation":"regional","correlation_rho":0.5,"transmission":["P-005"],"mitigation":"Metering verification, grid code compliance, redundant monitoring","status":"acknowledged","evidence_status":"quantified"},{"id":"R-13","name":"retail_tariff_level","display_name":"Retail tariff level change","description":"Sustained decrease in retail electricity prices compresses Averta revenue","category":"market_regulatory","type":"structural","correlation":"systematic","correlation_rho":1.0,"transmission":["P-021","P-022","P-023"],"mitigation":"Pass-through formula (85% of whatever tariff is — margin preserved in %)","status":"acknowledged","evidence_status":"evidenced"},{"id":"R-14","name":"regulatory_change","display_name":"Regulatory change (peaje treatment)","description":"Loss of peaje/cargo exemption for self-consumed energy, framework changes","category":"market_regulatory","type":"structural","correlation":"systematic","correlation_rho":1.0,"transmission":["P-021","P-022"],"mitigation":"Monitoring, legal advocacy, scenario analysis, draft RD 2025 tracking","status":"acknowledged","evidence_status":"identified"},{"id":"R-15","name":"pool_price_movement","display_name":"Pool price movement","description":"Sustained decrease in wholesale pool price reduces surplus compensation","category":"market_regulatory","type":"structural","correlation":"systematic","correlation_rho":1.0,"transmission":["P-024"],"mitigation":"Small revenue share (surplus ~20% of production with 80% autoconsumo)","status":"acknowledged","evidence_status":"quantified"},{"id":"R-16","name":"interest_rate_macro","display_name":"Interest rate / macro","description":"Rising rates increase cost of capital, reduce asset valuations","category":"market_regulatory","type":"structural","correlation":"systematic","correlation_rho":1.0,"transmission":["P-062","P-064"],"mitigation":"Fixed-rate debt, long-tenor contracts, IRR attractive above current rates","status":"acknowledged","evidence_status":"quantified"},{"id":"R-17","name":"platform_sponsor","display_name":"Platform / sponsor","description":"Scaling failure, management capacity constraints, key-person risk (Robert)","category":"platform","type":"managed","correlation":null,"correlation_rho":null,"transmission":[],"mitigation":"Team buildout, process documentation, system automation, CTLX governance","status":"acknowledged","evidence_status":"identified"}],"categories":{"pre_cod":[{"id":"R-01","name":"development","display_name":"Development","description":"Permit rejection, lease falls through, consumers not secured, interconnection denied. Three failure modes (roof, consumers, interconnection) — one risk: we deliver RTB or we don't.\n","category":"pre_cod","type":"managed","correlation":"independent","correlation_rho":0.0,"transmission":[],"mitigation":"Pipeline diversification, standardized process, parallel permitting","status":"acknowledged","evidence_status":"identified"},{"id":"R-02","name":"construction_epc","display_name":"Construction / EPC","description":"Cost overrun, construction delay, quality defects","category":"pre_cod","type":"priceable","correlation":"independent","correlation_rho":0.0,"transmission":["P-050"],"mitigation":"Fixed-price EPC contract, milestone payments (5/30/30/30/5), 2-year defect warranty","status":"acknowledged","evidence_status":"quantified"},{"id":"R-03","name":"stabilization","display_name":"Stabilization","description":"Commissioning failure, initial yield below forecast, connection issues","category":"pre_cod","type":"managed","correlation":"independent","correlation_rho":0.0,"transmission":[],"mitigation":"EPC defect warranty (2-yr), commissioning test protocol, 30-yr module production guarantee","status":"acknowledged","evidence_status":"identified"}],"operating":[{"id":"R-04","name":"production_shortfall","display_name":"Production shortfall (irradiance)","description":"Annual energy output below forecast due to weather variability, soiling, shading","category":"operating","type":"priceable","correlation":"regional","correlation_rho":0.7,"transmission":["P-002"],"mitigation":"Geographic diversification, P90 design, PVGIS-validated forecasts","status":"acknowledged","evidence_status":"evidenced"},{"id":"R-05","name":"equipment_degradation","display_name":"Equipment degradation","description":"Year-over-year production decline exceeding forecast degradation rate","category":"operating","type":"priceable","correlation":"independent","correlation_rho":0.0,"transmission":["P-003"],"mitigation":"Manufacturer 30-yr linear power warranty, module quality selection","status":"acknowledged","evidence_status":"evidenced"},{"id":"R-06","name":"equipment_failure_performance","display_name":"Equipment failure / performance","description":"Inverter failure, module hotspot, wiring fault, performance below spec","category":"operating","type":"priceable","correlation":"independent","correlation_rho":0.0,"transmission":["P-030","P-004"],"mitigation":"5-yr inverter warranty, O&M contract, all-risk insurance","status":"acknowledged","evidence_status":"quantified"},{"id":"R-07","name":"consumer_default_churn","display_name":"Consumer default / churn","description":"Consumer non-payment, business closure, relocation, voluntary switch","category":"operating","type":"priceable","correlation":"partially_correlated","correlation_rho":0.2,"transmission":["P-011","P-012","P-040"],"mitigation":"SEPA direct debit, replacement provision, credit screening, multi-offtaker structure","status":"acknowledged","evidence_status":"quantified"},{"id":"R-08","name":"autoconsumo_ratio_variability","display_name":"Autoconsumo ratio variability","description":"Self-consumption ratio lower than forecast — more surplus, less PPA revenue","category":"operating","type":"priceable","correlation":"partially_correlated","correlation_rho":0.3,"transmission":["P-010"],"mitigation":"Coefficient optimization (Elecsum), consumer mix matching, demand profiling","status":"acknowledged","evidence_status":"quantified"},{"id":"R-09","name":"counterparty_concentration","display_name":"Counterparty concentration","description":"Revenue concentration in few consumers or sectors within a project/portfolio","category":"operating","type":"priceable","correlation":"portfolio_level","correlation_rho":null,"transmission":[],"mitigation":"Minimum consumer count per project, sector diversification, geographic spread","status":"acknowledged","evidence_status":"identified"},{"id":"R-10","name":"rooftop_lease","display_name":"Rooftop / lease","description":"Property sale, building demolition, lease termination, access disputes","category":"operating","type":"priceable","correlation":"independent","correlation_rho":0.0,"transmission":["P-032"],"mitigation":"25-year lease, assignment clause, surface rights option, €1 reversión at end","status":"acknowledged","evidence_status":"quantified"},{"id":"R-11","name":"allocation_settlement","display_name":"Allocation / settlement","description":"Coefficient errors, DSO delays, billing disputes, Elecsum service failures","category":"operating","type":"managed","correlation":"partially_correlated","correlation_rho":0.4,"transmission":[],"mitigation":"Elecsum SLA, coefficient audit process, distribuidora escalation protocol","status":"acknowledged","evidence_status":"identified"},{"id":"R-12","name":"grid_interface","display_name":"Grid / interface","description":"Curtailment, metering errors, grid compliance issues, DSO interaction","category":"operating","type":"managed","correlation":"regional","correlation_rho":0.5,"transmission":["P-005"],"mitigation":"Metering verification, grid code compliance, redundant monitoring","status":"acknowledged","evidence_status":"quantified"}],"market_regulatory":[{"id":"R-13","name":"retail_tariff_level","display_name":"Retail tariff level change","description":"Sustained decrease in retail electricity prices compresses Averta revenue","category":"market_regulatory","type":"structural","correlation":"systematic","correlation_rho":1.0,"transmission":["P-021","P-022","P-023"],"mitigation":"Pass-through formula (85% of whatever tariff is — margin preserved in %)","status":"acknowledged","evidence_status":"evidenced"},{"id":"R-14","name":"regulatory_change","display_name":"Regulatory change (peaje treatment)","description":"Loss of peaje/cargo exemption for self-consumed energy, framework changes","category":"market_regulatory","type":"structural","correlation":"systematic","correlation_rho":1.0,"transmission":["P-021","P-022"],"mitigation":"Monitoring, legal advocacy, scenario analysis, draft RD 2025 tracking","status":"acknowledged","evidence_status":"identified"},{"id":"R-15","name":"pool_price_movement","display_name":"Pool price movement","description":"Sustained decrease in wholesale pool price reduces surplus compensation","category":"market_regulatory","type":"structural","correlation":"systematic","correlation_rho":1.0,"transmission":["P-024"],"mitigation":"Small revenue share (surplus ~20% of production with 80% autoconsumo)","status":"acknowledged","evidence_status":"quantified"},{"id":"R-16","name":"interest_rate_macro","display_name":"Interest rate / macro","description":"Rising rates increase cost of capital, reduce asset valuations","category":"market_regulatory","type":"structural","correlation":"systematic","correlation_rho":1.0,"transmission":["P-062","P-064"],"mitigation":"Fixed-rate debt, long-tenor contracts, IRR attractive above current rates","status":"acknowledged","evidence_status":"quantified"}],"platform":[{"id":"R-17","name":"platform_sponsor","display_name":"Platform / sponsor","description":"Scaling failure, management capacity constraints, key-person risk (Robert)","category":"platform","type":"managed","correlation":null,"correlation_rho":null,"transmission":[],"mitigation":"Team buildout, process documentation, system automation, CTLX governance","status":"acknowledged","evidence_status":"identified"}]},"evidenced_count":3,"quantified_count":11,"evidence_coverage":0.1765},"sensitivity":[{"param":"autoconsumo_ratio","base_value":0.8,"low_value":0.4,"high_value":0.98,"irr_low":0.077,"irr_base":0.1557,"irr_high":0.1907,"delta_low":-0.0788,"delta_high":0.035,"total_swing":0.1138},{"param":"retail_tariff_escalation","base_value":0.02,"low_value":0.0008,"high_value":0.0392,"irr_low":0.1192,"irr_base":0.1557,"irr_high":0.1883,"delta_low":-0.0366,"delta_high":0.0325,"total_swing":0.0691},{"param":"capex_per_kwp","base_value":604.25,"low_value":527.45,"high_value":681.05,"irr_low":0.1841,"irr_base":0.1557,"irr_high":0.1339,"delta_low":0.0283,"delta_high":-0.0218,"total_swing":0.0502},{"param":"consumer_default_rate","base_value":0.03,"low_value":0.0,"high_value":0.15,"irr_low":0.1557,"irr_base":0.1557,"irr_high":0.112,"delta_low":0.0,"delta_high":-0.0438,"total_swing":0.0438},{"param":"specific_yield","base_value":1347.0,"low_value":1260.792,"high_value":1433.208,"irr_low":0.1371,"irr_base":0.1557,"irr_high":0.1744,"delta_low":-0.0186,"delta_high":0.0186,"total_swing":0.0373},{"param":"pool_compensation_price","base_value":0.045,"low_value":0.0322,"high_value":0.0578,"irr_low":0.148,"irr_base":0.1557,"irr_high":0.1635,"delta_low":-0.0077,"delta_high":0.0077,"total_swing":0.0154},{"param":"opex_maintenance_per_kwp","base_value":12.0,"low_value":9.44,"high_value":14.56,"irr_low":0.1616,"irr_base":0.1557,"irr_high":0.1499,"delta_low":0.0059,"delta_high":-0.0059,"total_swing":0.0117},{"param":"opex_escalation","base_value":0.02,"low_value":0.0072,"high_value":0.0328,"irr_low":0.1585,"irr_base":0.1557,"irr_high":0.1526,"delta_low":0.0027,"delta_high":-0.0032,"total_swing":0.0059},{"param":"degradation_rate","base_value":0.0035,"low_value":0.0022,"high_value":0.0048,"irr_low":0.1581,"irr_base":0.1557,"irr_high":0.1534,"delta_low":0.0023,"delta_high":-0.0023,"total_swing":0.0047},{"param":"performance_ratio","base_value":0.82,"low_value":0.7816,"high_value":0.8584,"irr_low":0.1557,"irr_base":0.1557,"irr_high":0.1557,"delta_low":0.0,"delta_high":0.0,"total_swing":0.0},{"param":"curtailment_factor","base_value":0.02,"low_value":0.0,"high_value":0.15,"irr_low":0.1557,"irr_base":0.1557,"irr_high":0.1557,"delta_low":0.0,"delta_high":0.0,"total_swing":0.0},{"param":"consumer_occupancy_rate","base_value":0.9,"low_value":0.5,"high_value":1.0,"irr_low":0.1557,"irr_base":0.1557,"irr_high":0.1557,"delta_low":0.0,"delta_high":0.0,"total_swing":0.0},{"param":"annual_churn_rate","base_value":0.1,"low_value":0.02,"high_value":0.3,"irr_low":0.1557,"irr_base":0.1557,"irr_high":0.1557,"delta_low":0.0,"delta_high":0.0,"total_swing":0.0},{"param":"churn_replacement_time_months","base_value":0.0,"low_value":1,"high_value":12,"irr_low":0.1557,"irr_base":0.1557,"irr_high":0.1557,"delta_low":0.0,"delta_high":0.0,"total_swing":0.0}],"portfolio":{"diversification_curve":[{"n_projects":1,"p10":0.0983,"p50":0.1427,"p90":0.1949,"std":0.0365,"spread_p10_p90":0.0966},{"n_projects":5,"p10":0.1271,"p50":0.1463,"p90":0.1648,"std":0.0259,"spread_p10_p90":0.0377},{"n_projects":10,"p10":0.1313,"p50":0.1497,"p90":0.161,"std":0.0191,"spread_p10_p90":0.0296},{"n_projects":25,"p10":0.1366,"p50":0.149,"p90":0.1577,"std":0.0098,"spread_p10_p90":0.0211},{"n_projects":50,"p10":0.1398,"p50":0.1476,"p90":0.1538,"std":0.0064,"spread_p10_p90":0.0139},{"n_projects":100,"p10":0.14,"p50":0.1471,"p90":0.1526,"std":0.0051,"spread_p10_p90":0.0126}]}};
</script>
<script>
const {
  useState,
  useMemo,
  useCallback
} = React;

const {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
  ResponsiveContainer,
  Cell,
  ComposedChart,
  Line,
  ReferenceLine,
  Legend,
  Area,
  AreaChart,
  LineChart,
  PieChart,
  Pie
} = Recharts;

function zoneRates(zoneKey, marketMult) {
  var mm = (typeof marketMult === 'number') ? marketMult : 1.0;
  var df = D.tariff.discount_factor;  // 0.85
  var z = D.production.synthetic_zones[zoneKey];
  if (z && z.eff_rate_3td) {
    return {
      eff_rate_3td: z.eff_rate_3td + df * z.sw_market_3td * (mm - 1),
      eff_rate_2td: z.eff_rate_2td + df * z.sw_market_2td * (mm - 1),
      sw_market_3td: z.sw_market_3td,
      sw_market_2td: z.sw_market_2td
    };
  }
  var g = D.irr_grid;
  return {
    eff_rate_3td: g.eff_rate_3td + df * g.sw_market_3td * (mm - 1),
    eff_rate_2td: g.eff_rate_2td + df * g.sw_market_2td * (mm - 1),
    sw_market_3td: g.sw_market_3td,
    sw_market_2td: g.sw_market_2td
  };
}

const fmt = (v, d = 1) => v != null ? Number(v).toLocaleString('en', {
  minimumFractionDigits: d,
  maximumFractionDigits: d
}) : '—';
const fmtPct = v => v != null ? `${(v * 100).toFixed(2)}%` : '—';
const fmtEur = (v, d = 0) => v != null ? `€${Number(v).toLocaleString('en', {
  minimumFractionDigits: d,
  maximumFractionDigits: d
})}` : '—';
function trilinearInterp(values, axes, x, y, z) {
  const lerp = (a, b, t) => a + (b - a) * t;
  const findBracket = (arr, val) => {
    if (val <= arr[0]) return [0, 0, 0];
    if (val >= arr[arr.length - 1]) return [arr.length - 1, arr.length - 1, 0];
    for (let i = 0; i < arr.length - 1; i++) {
      if (val >= arr[i] && val <= arr[i + 1]) {
        const t = (val - arr[i]) / (arr[i + 1] - arr[i]);
        return [i, i + 1, t];
      }
    }
    return [arr.length - 1, arr.length - 1, 0];
  };
  const [xi0, xi1, xt] = findBracket(axes.specific_yield, x);
  const [yi0, yi1, yt] = findBracket(axes.tariff_mix_2td, y);
  const [zi0, zi1, zt] = findBracket(axes.autoconsumo_ratio, z);
  const v = (i, j, k) => {
    const val = values[i]?.[j]?.[k];
    return val != null ? val : 0;
  };
  const c00 = lerp(v(xi0, yi0, zi0), v(xi1, yi0, zi0), xt);
  const c01 = lerp(v(xi0, yi0, zi1), v(xi1, yi0, zi1), xt);
  const c10 = lerp(v(xi0, yi1, zi0), v(xi1, yi1, zi0), xt);
  const c11 = lerp(v(xi0, yi1, zi1), v(xi1, yi1, zi1), xt);
  const c0 = lerp(c00, c10, yt);
  const c1 = lerp(c01, c11, yt);
  return lerp(c0, c1, zt);
}
function computeIRR(cashflows, tol = 1e-8, maxIter = 200) {
  const npv = r => cashflows.reduce((s, cf, t) => s + cf / Math.pow(1 + r, t), 0);
  let lo = -0.5,
    hi = 2.0;
  if (npv(lo) < 0 || npv(hi) > 0) {
    lo = -0.99;
    hi = 10.0;
  }
  for (let i = 0; i < maxIter; i++) {
    const mid = (lo + hi) / 2;
    const v = npv(mid);
    if (Math.abs(v) < tol) return mid;
    if (v > 0) lo = mid;else hi = mid;
  }
  return (lo + hi) / 2;
}

const irrColor = (v) => v >= 0.08 ? '#22c55e' : v >= 0.04 ? '#f59e0b' : '#ef4444';
const riskTypeColor = (t) => t === 'priceable' ? '#60a5fa' : t === 'structural' ? '#f472b6' : '#a78bfa';
const riskTypeIcon = (t) => t === 'priceable' ? '◆' : t === 'structural' ? '◇' : '○';
const riskTypeLabel = (t) => t === 'priceable' ? 'Quantifiable — modelable with P10/P90 ranges' : t === 'structural' ? 'Structural — systematic, scenario analysis only' : 'Operational — mitigated by contracts/processes';
const evidenceIcon = (s) => s === 'evidenced' ? '●' : s === 'quantified' ? '◐' : '○';
const evidenceColor = (s) => s === 'evidenced' ? '#22c55e' : s === 'quantified' ? '#f59e0b' : '#6b7280';
const evidenceLabel = (s) => s === 'evidenced' ? 'Evidenced — data room reference available' : s === 'quantified' ? 'Quantified — P10/P90 set, pending evidence' : 'Identified — named, not yet calibrated';
const categoryColor = (c) => ({
  pre_cod: '#f59e0b', operating: '#60a5fa', market_regulatory: '#f472b6', platform: '#a78bfa'
})[c] || '#6b7280';


function Slider({
  label,
  value,
  min,
  max,
  step,
  onChange,
  format,
  unit
}) {
  const display = format ? format(value) : `${fmt(value, 1)}${unit ? ' ' + unit : ''}`;
  return /*#__PURE__*/React.createElement("div", {
    className: "mb-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex justify-between text-xs mb-1"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, label), /*#__PURE__*/React.createElement("span", {
    className: "font-mono text-gray-300"
  }, display)), /*#__PURE__*/React.createElement("input", {
    type: "range",
    className: "w-full slider-track",
    min: min,
    max: max,
    step: step,
    value: value,
    onChange: e => onChange(parseFloat(e.target.value))
  }));
}
function ZoneSelector({
  zones,
  selected,
  onChange
}) {
  return /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-1 text-xs"
  }, Object.entries(zones).map(([key, z]) => /*#__PURE__*/React.createElement("button", {
    key: key,
    onClick: () => onChange(key),
    className: `px-1 py-0.5 rounded text-left truncate ${selected === key ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : 'bg-gray-800 text-gray-500 border border-gray-700 hover:text-gray-300'}`
  }, z.name.split('(')[0].trim())));
}
function ToggleButton({
  label,
  active,
  onClick
}) {
  return /*#__PURE__*/React.createElement("button", {
    onClick: onClick,
    className: `text-xs px-2 py-1 rounded flex-1 ${active ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : 'bg-gray-800 text-gray-500 border border-gray-700'}`
  }, label);
}

function MetricCard({label, value, sub, color}) {
  return React.createElement('div', {className: 'panel p-3 text-center'},
    React.createElement('div', {className: 'text-xs text-gray-500'}, label),
    React.createElement('div', {className: 'text-xl font-mono font-bold', style: {color: color || '#e2e4e9'}}, value),
    sub ? React.createElement('div', {className: 'text-xs text-gray-600 mt-1'}, sub) : null);
}

// =====================================================================
// Bankability Score Badge
// =====================================================================
function BankabilityBadge() {
  const rr = D.risk_register;
  const score = rr.evidence_coverage != null ? rr.evidence_coverage : rr.bankability_score;
  const total = rr.total_risks;
  const evidenced = rr.evidenced_count || 0;
  const quantified = rr.quantified_count || 0;
  const color = score >= 0.7 ? '#22c55e' : score >= 0.4 ? '#f59e0b' : '#ef4444';
  const label = score >= 0.7 ? 'WELL EVIDENCED' : score >= 0.4 ? 'PARTIALLY EVIDENCED' : 'CALIBRATION PENDING';
  return React.createElement('div', {className: 'panel p-4 text-center'},
    React.createElement('div', {className: 'text-xs text-gray-500 mb-1'}, 'Evidence Coverage'),
    React.createElement('div', {style: {color: color, fontSize: '2rem', fontWeight: 'bold', fontFamily: 'monospace'}},
      (score * 100).toFixed(0) + '%'),
    React.createElement('div', {style: {color: color}, className: 'text-sm font-bold mt-1'}, label),
    React.createElement('div', {className: 'text-xs text-gray-600 mt-2'}, evidenced + '/' + total + ' risks evidenced'),
    React.createElement('div', {className: 'text-xs text-gray-600 mt-0.5'}, quantified + '/' + total + ' risks quantified'),
    React.createElement('div', {className: 'w-full bg-gray-700 rounded-full h-2 mt-2'},
      React.createElement('div', {className: 'h-2 rounded-full', style: {width: (score*100)+'%', background: color}}))
  );
}

// =====================================================================
// MC IRR Distribution
// =====================================================================

function PanelProduction({
  yield: sy,
  selectedZone,
  pvgisAdjust
}) {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const pandrol = D.production.actuals.pandrol_2025;
  const alfe25 = D.production.actuals.alfe_2025;
  const zone = D.production.synthetic_zones[selectedZone] || D.production.synthetic_zones.cantabrico;
  const excelYield = D.production.reference.excel_model_specific_yield;
  const pvgisMult = pvgisAdjust ? 0.85 : 1.0;
  const pvgisLabel = pvgisAdjust ? ' (\u00D70.85)' : '';
  const pvgisKey = 'PVGIS ' + zone.name.split('(')[0].trim() + pvgisLabel;
  const pvgisAnnual = zone.annual_yield_per_kwp * pvgisMult;
  const chartData = months.map((m, i) => ({
    month: m,
    'Pandrol actual': Math.round(pandrol.monthly_kwh_per_kwp[i] * 10) / 10,
    'Alfe actual': Math.round(alfe25.monthly_kwh_per_kwp[i] * 10) / 10,
    [pvgisKey]: Math.round(zone.monthly_kwh_per_kwp[i] * pvgisMult * 10) / 10,
    'Original projection': Math.round(excelYield / 12 * 10) / 10,
    'Selected yield': Math.round(sy / 12 * 10) / 10
  }));
  return /*#__PURE__*/React.createElement("div", {
    className: "panel p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-semibold text-gray-300 mb-1"
  }, "Production \u2014 Yield Benchmarking"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mb-3"
  }, "Monthly kWh/kWp: comparable installations (Pandrol, Alfe) vs PVGIS ", zone.name, " vs original projection"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 sm:grid-cols-4 gap-2 mb-3 text-xs"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Pandrol 2025"), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-mono text-emerald-400"
  }, fmt(pandrol.specific_yield, 0)), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "kWh/kWp")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Alfe 2025"), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-mono text-orange-400"
  }, fmt(alfe25.specific_yield, 0)), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "kWh/kWp")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "PVGIS ", zone.name.split('(')[0].trim(), pvgisLabel), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-mono text-blue-400"
  }, fmt(pvgisAnnual, 0)), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "kWh/kWp")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Original projection"), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-mono text-red-400"
  }, fmt(excelYield, 0)), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "kWh/kWp"))), /*#__PURE__*/React.createElement(ResponsiveContainer, {
    width: "100%",
    height: 220
  }, /*#__PURE__*/React.createElement(ComposedChart, {
    data: chartData,
    barCategoryGap: "15%"
  }, /*#__PURE__*/React.createElement(CartesianGrid, {
    strokeDasharray: "3 3",
    stroke: "#2a2d35"
  }), /*#__PURE__*/React.createElement(XAxis, {
    dataKey: "month",
    tick: {
      fill: '#6b7280',
      fontSize: 10
    }
  }), /*#__PURE__*/React.createElement(YAxis, {
    tick: {
      fill: '#6b7280',
      fontSize: 10
    }
  }), /*#__PURE__*/React.createElement(Tooltip, {
    contentStyle: {
      background: '#1a1d24',
      border: '1px solid #2a2d35',
      fontSize: 11
    }
  }), /*#__PURE__*/React.createElement(Bar, {
    dataKey: "Pandrol actual",
    fill: "#22c55e",
    fillOpacity: 0.6
  }), /*#__PURE__*/React.createElement(Bar, {
    dataKey: "Alfe actual",
    fill: "#f97316",
    fillOpacity: 0.4
  }), /*#__PURE__*/React.createElement(Line, {
    type: "monotone",
    dataKey: pvgisKey,
    stroke: "#3b82f6",
    strokeWidth: 2,
    dot: false
  }), /*#__PURE__*/React.createElement(Line, {
    type: "monotone",
    dataKey: "Original projection",
    stroke: "#ef4444",
    strokeDasharray: "4 4",
    strokeWidth: 1,
    dot: false
  }), /*#__PURE__*/React.createElement(Line, {
    type: "monotone",
    dataKey: "Selected yield",
    stroke: "#f59e0b",
    strokeWidth: 2,
    dot: false
  }))), /*#__PURE__*/React.createElement("div", {
    className: "mt-2 text-xs text-gray-500 flex gap-4 justify-center"
  }, /*#__PURE__*/React.createElement("span", null, /*#__PURE__*/React.createElement("span", {
    className: "inline-block w-3 h-2 bg-emerald-500 rounded mr-1"
  }), "Pandrol"), /*#__PURE__*/React.createElement("span", null, /*#__PURE__*/React.createElement("span", {
    className: "inline-block w-3 h-2 bg-orange-500 rounded mr-1"
  }), "Alfe"), /*#__PURE__*/React.createElement("span", {
    className: "text-blue-400"
  }, "\u2014 PVGIS ", zone.name.split('(')[0].trim()), /*#__PURE__*/React.createElement("span", {
    className: "text-red-400"
  }, "-- Projection"), /*#__PURE__*/React.createElement("span", {
    className: "text-amber-400"
  }, "\u2014 Selected")));
}

// =====================================================================
// PANEL 2: SUMPRODUCT PHYSICS (restored original layout, DF=0.85)
// =====================================================================
function PanelSumproduct({
  mix2td
}) {
  const [tariffType, setTariffType] = useState('20TD');
  const [season, setSeason] = useState('alta');
  const sd = D.sumproduct_detail;
  const sp = D.sumproduct.pandrol;
  const tariff = D.tariff.prices_2026;
  const cal = D.tariff.calendar_summary;
  const pColors6 = ['', '#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#6366f1'];
  const pColors3 = ['', '#ef4444', '#f59e0b', '#6366f1'];
  const pColors = tariffType === '20TD' ? pColors3 : pColors6;
  const nPeriods = tariffType === '20TD' ? 3 : 6;

  // VIEW A: 24-hour overlay
  const periodMap = tariffType === '20TD' ? sd.period_maps['20TD'].workday : sd.period_maps['30TD'][season] || sd.period_maps['30TD'].alta;
  const prodShape = sd.production_shape_by_tariff_season[season] || sd.production_shape_by_tariff_season.alta;
  const overlayData = Array.from({
    length: 24
  }, (_, h) => ({
    hour: h,
    label: `${h}:00`,
    production: Math.round(prodShape[h] * 1000) / 10,
    period: periodMap[h],
    periodLabel: tariffType === '20TD' ? ['', 'Punta', 'Llano', 'Valle'][periodMap[h]] : `P${periodMap[h]}`,
    rate: tariff[tariffType].averta[periodMap[h] - 1]
  }));

  // VIEW B: Period revenue anatomy
  const spData = sp[tariffType];
  const rates = tariff[tariffType].averta;
  const labels = cal[tariffType].labels;
  const solarHours = cal[tariffType].solar_hours_per_period;
  const anatomyData = labels.map((l, i) => ({
    period: l,
    kwh: Math.round(spData.kwh_by_period[i]),
    rate: rates[i],
    revenue: spData.revenue_by_period[i],
    solarHours: solarHours[i],
    pctKwh: spData.pct_by_period[i]
  }));
  const effRate = spData.effective_rate;
  const rc = sd.rate_comparison;
  const flatRate = tariffType === '20TD' ? rc.flat_profile_2td : rc.flat_profile_3td;
  const solarRate = tariffType === '20TD' ? rc.solar_weighted_2td : rc.solar_weighted_3td;
  const penalty = tariffType === '20TD' ? rc.solar_vs_flat_penalty_2td : rc.solar_vs_flat_penalty_3td;
  const seasonLabels = {
    alta: 'Alta (Ene,Feb,Jul,Dic)',
    media_alta: 'Media-alta (Mar,Nov)',
    media: 'Media (Jun,Ago,Sep)',
    baja: 'Baja (Abr,May,Oct)'
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "panel p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-semibold text-gray-300 mb-1"
  }, "Tariff Period Revenue Analysis"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mb-3"
  }, "Revenue = \u03A3", /*#__PURE__*/React.createElement("sub", null, "h"), "(kWh", /*#__PURE__*/React.createElement("sub", null, "h"), " \xD7 tariff_period", /*#__PURE__*/React.createElement("sub", null, "h"), " \xD7 ", D.tariff.discount_factor, "). Actual hourly production profile \xD7 CNMC 2026 regulated tariffs."), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 mb-3"
  }, ['20TD', '30TD'].map(t => /*#__PURE__*/React.createElement("button", {
    key: t,
    onClick: () => setTariffType(t),
    className: `text-xs px-3 py-1 rounded ${tariffType === t ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : 'bg-gray-800 text-gray-500 border border-gray-700'}`
  }, t.replace('0', '.0'))), /*#__PURE__*/React.createElement("span", {
    className: "ml-auto text-xs text-gray-600"
  }, "Eff. rate: ", /*#__PURE__*/React.createElement("span", {
    className: "text-amber-400 font-mono"
  }, "\u20AC", effRate.toFixed(4)), "/kWh", penalty !== 0 && /*#__PURE__*/React.createElement("span", {
    className: penalty > 0 ? 'text-emerald-400' : 'text-red-400'
  }, ' ', "(", penalty > 0 ? '+' : '', penalty.toFixed(1), "% vs flat)"))), tariffType === '30TD' && /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1 mb-3 flex-wrap"
  }, Object.entries(seasonLabels).map(([k, label]) => /*#__PURE__*/React.createElement("button", {
    key: k,
    onClick: () => setSeason(k),
    className: `text-xs px-2 py-0.5 rounded ${season === k ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' : 'bg-gray-800 text-gray-500 border border-gray-700'}`
  }, label))), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 mb-1 font-semibold"
  }, "Hourly production vs tariff periods (workday)"), /*#__PURE__*/React.createElement(ResponsiveContainer, {
    width: "100%",
    height: 180
  }, /*#__PURE__*/React.createElement(ComposedChart, {
    data: overlayData,
    margin: {
      left: 0,
      right: 10,
      top: 5,
      bottom: 0
    }
  }, /*#__PURE__*/React.createElement(CartesianGrid, {
    strokeDasharray: "3 3",
    stroke: "#2a2d35"
  }), /*#__PURE__*/React.createElement(XAxis, {
    dataKey: "label",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    interval: 2
  }), /*#__PURE__*/React.createElement(YAxis, {
    yAxisId: "prod",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => `${v}%`
  }), /*#__PURE__*/React.createElement(YAxis, {
    yAxisId: "rate",
    orientation: "right",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => `€${v.toFixed(2)}`,
    domain: [0, 'auto']
  }), /*#__PURE__*/React.createElement(Tooltip, {
    contentStyle: {
      background: '#1a1d24',
      border: '1px solid #2a2d35',
      fontSize: 11
    },
    formatter: (v, name) => name === 'rate' ? `€${v.toFixed(4)}/kWh` : `${v.toFixed(1)}%`
  }), /*#__PURE__*/React.createElement(Bar, {
    yAxisId: "prod",
    dataKey: "production",
    name: "Production %",
    radius: [2, 2, 0, 0]
  }, overlayData.map((e, i) => /*#__PURE__*/React.createElement(Cell, {
    key: i,
    fill: pColors[e.period],
    fillOpacity: 0.6
  }))), /*#__PURE__*/React.createElement(Line, {
    yAxisId: "rate",
    type: "stepAfter",
    dataKey: "rate",
    name: "rate",
    stroke: "#f59e0b",
    strokeWidth: 2,
    dot: false
  }), /*#__PURE__*/React.createElement(ReferenceLine, {
    yAxisId: "rate",
    y: effRate,
    stroke: "#f59e0b",
    strokeDasharray: "5 3",
    strokeWidth: 1,
    label: {
      value: `eff ${effRate.toFixed(3)}`,
      fill: '#f59e0b',
      fontSize: 9,
      position: 'right'
    }
  }))), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-600 mt-1 mb-3"
  }, "Bar color = tariff period. Bar height = % of daily production in that hour (actual Pandrol profile). Amber line = Averta rate per period."), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 mb-1 font-semibold"
  }, "Revenue by tariff period"), /*#__PURE__*/React.createElement(ResponsiveContainer, {
    width: "100%",
    height: 160
  }, /*#__PURE__*/React.createElement(ComposedChart, {
    data: anatomyData,
    barCategoryGap: "20%",
    margin: {
      left: 0,
      right: 10,
      top: 5,
      bottom: 0
    }
  }, /*#__PURE__*/React.createElement(CartesianGrid, {
    strokeDasharray: "3 3",
    stroke: "#2a2d35"
  }), /*#__PURE__*/React.createElement(XAxis, {
    dataKey: "period",
    tick: {
      fill: '#9ca3af',
      fontSize: 10
    }
  }), /*#__PURE__*/React.createElement(YAxis, {
    yAxisId: "kwh",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => `${(v / 1000).toFixed(0)}k`
  }), /*#__PURE__*/React.createElement(YAxis, {
    yAxisId: "rate",
    orientation: "right",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => `€${v.toFixed(2)}`,
    domain: [0, 'auto']
  }), /*#__PURE__*/React.createElement(Tooltip, {
    contentStyle: {
      background: '#1a1d24',
      border: '1px solid #2a2d35',
      fontSize: 11
    }
  }), /*#__PURE__*/React.createElement(Bar, {
    yAxisId: "kwh",
    dataKey: "kwh",
    name: "kWh",
    radius: [2, 2, 0, 0]
  }, anatomyData.map((e, i) => /*#__PURE__*/React.createElement(Cell, {
    key: i,
    fill: pColors[i + 1],
    fillOpacity: 0.7
  }))), /*#__PURE__*/React.createElement(Line, {
    yAxisId: "rate",
    type: "monotone",
    dataKey: "rate",
    name: "Averta rate",
    stroke: "#f59e0b",
    strokeWidth: 2,
    dot: {
      r: 3,
      fill: '#f59e0b'
    }
  }), /*#__PURE__*/React.createElement(ReferenceLine, {
    yAxisId: "rate",
    y: flatRate,
    stroke: "#6b7280",
    strokeDasharray: "4 2",
    label: {
      value: `flat ${flatRate.toFixed(3)}`,
      fill: '#6b7280',
      fontSize: 9,
      position: 'right'
    }
  }), /*#__PURE__*/React.createElement(ReferenceLine, {
    yAxisId: "rate",
    y: effRate,
    stroke: "#f59e0b",
    strokeDasharray: "5 3",
    label: {
      value: `eff ${effRate.toFixed(3)}`,
      fill: '#f59e0b',
      fontSize: 9,
      position: 'right'
    }
  }))), /*#__PURE__*/React.createElement("div", {
    className: "mt-2 grid grid-cols-3 gap-2 text-xs"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Flat profile rate"), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-400 font-mono"
  }, "\u20AC", flatRate.toFixed(4), "/kWh"), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-600"
  }, "Uniform production")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Solar-weighted rate"), /*#__PURE__*/React.createElement("div", {
    className: "text-amber-400 font-mono"
  }, "\u20AC", solarRate.toFixed(4), "/kWh"), /*#__PURE__*/React.createElement("div", {
    className: penalty >= 0 ? 'text-emerald-400' : 'text-red-400'
  }, penalty >= 0 ? '+' : '', penalty.toFixed(1), "% vs flat")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Revenue impact"), /*#__PURE__*/React.createElement("div", {
    className: "font-mono text-gray-300"
  }, "\u20AC", Math.round((solarRate - flatRate) * D.metadata.reference_kwp * 980 * 0.80), "/yr"), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-600"
  }, "at 980 kWh/kWp, 80% AC"))));
}

// =====================================================================
// PANEL 3: REVENUE SENSITIVITY (horizontal bar scenario comparison)
// =====================================================================
function PanelRevenue({
  sy,
  mix2td,
  autoconsumo,
  poolPrice,
  revenueMode,
  selectedZone,
  marketMult
}) {
  const grid = D.irr_grid;
  const kwp = D.metadata.reference_kwp;
  const annualKWh = kwp * sy;
  const selfConsumed = annualKWh * autoconsumo;
  const surplus = annualKWh * (1 - autoconsumo);
  const zr = zoneRates(selectedZone, marketMult);
  const effRate3td = zr.eff_rate_3td;
  const effRate2td = zr.eff_rate_2td;
  const effRateIndexed = mix2td * effRate2td + (1 - mix2td) * effRate3td;
  const effRateBlended = 0.070;
  const effRate = revenueMode === 'indexed' ? effRateIndexed : effRateBlended;
  const revAuto = selfConsumed * effRate;
  const revSurplus = surplus * poolPrice;
  const revTotal = revAuto + revSurplus;
  // scenario comparison data for horizontal bars
  const compData = [
    {name: 'Blended flat rate', value: Math.round(selfConsumed * 0.070 + surplus * poolPrice), fill: '#ef4444',
     rate: '\u20AC0.070/kWh'},
    {name: '100% 3.0TD indexed', value: Math.round(selfConsumed * effRate3td + surplus * poolPrice), fill: '#6366f1',
     rate: '\u20AC' + effRate3td.toFixed(4) + '/kWh'},
    {name: 'Current mix (' + (mix2td*100).toFixed(0) + '% 2.0TD)', value: Math.round(selfConsumed * effRateIndexed + surplus * poolPrice), fill: '#f59e0b',
     rate: '\u20AC' + effRateIndexed.toFixed(4) + '/kWh'},
    {name: '100% 2.0TD indexed', value: Math.round(selfConsumed * effRate2td + surplus * poolPrice), fill: '#22c55e',
     rate: '\u20AC' + effRate2td.toFixed(4) + '/kWh'}
  ];
  return /*#__PURE__*/React.createElement("div", {
    className: "panel p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-semibold text-gray-300 mb-1"
  }, "Revenue \u2014 Pricing Scenario Comparison"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mb-3"
  }, "Annual revenue by pricing scenario at ", fmt(sy,0), " kWh/kWp, ", (autoconsumo*100).toFixed(0), "% autoconsumo"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 sm:grid-cols-4 gap-2 mb-3 text-xs"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Annual kWh"), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-mono text-gray-300"
  }, fmt(annualKWh, 0))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Eff. rate (", revenueMode, ")"), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-mono text-amber-400"
  }, "\u20AC", effRate.toFixed(4)), /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "/kWh")), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Autoconsumo rev."), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-mono text-emerald-400"
  }, fmtEur(revAuto, 0))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Surplus rev."), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-mono text-purple-400"
  }, fmtEur(revSurplus, 0)))), /*#__PURE__*/React.createElement(ResponsiveContainer, {
    width: "100%",
    height: 200
  }, /*#__PURE__*/React.createElement(BarChart, {
    data: compData,
    layout: "vertical",
    barSize: 20,
    margin: {left: 10, right: 40, top: 5, bottom: 5}
  }, /*#__PURE__*/React.createElement(CartesianGrid, {
    strokeDasharray: "3 3",
    stroke: "#2a2d35",
    horizontal: false
  }), /*#__PURE__*/React.createElement(XAxis, {
    type: "number",
    tick: {fill: '#6b7280', fontSize: 10},
    tickFormatter: function(v) { return '\u20AC' + (v/1000).toFixed(0) + 'k'; }
  }), /*#__PURE__*/React.createElement(YAxis, {
    type: "category",
    dataKey: "name",
    width: 140,
    tick: {fill: '#9ca3af', fontSize: 11}
  }), /*#__PURE__*/React.createElement(Tooltip, {
    contentStyle: {background: '#1a1d24', border: '1px solid #2a2d35', fontSize: 11},
    formatter: function(v) { return fmtEur(v, 0); }
  }), /*#__PURE__*/React.createElement(Bar, {
    dataKey: "value",
    radius: [0, 4, 4, 0],
    label: {position: 'right', fill: '#9ca3af', fontSize: 10, formatter: function(v) { return fmtEur(v, 0); }},
    isAnimationActive: false
  }, compData.map(function(entry, idx) {
    return /*#__PURE__*/React.createElement(Cell, {key: idx, fill: entry.fill});
  })))), /*#__PURE__*/React.createElement("div", {
    className: "mt-2 text-xs text-gray-500"
  }, revenueMode === 'indexed' && effRateIndexed < 0.070 && /*#__PURE__*/React.createElement("span", {
    className: "text-amber-400"
  }, "Indexed rate (\u20AC", effRateIndexed.toFixed(4), ") is below blended (\u20AC0.070). Production concentrates in low-tariff periods."), revenueMode === 'blended' && /*#__PURE__*/React.createElement("span", {
    className: "text-gray-400"
  }, "Blended mode uses flat \u20AC70/MWh rate. Switch to Indexed for period-specific pricing.")));
}

// =====================================================================
// P&L + CASH FLOW (synced zero lines, toggles, drill-down)
// =====================================================================
function PanelPnL({
  sy,
  mix2td,
  autoconsumo,
  poolPrice,
  revenueMode,
  includeTax,
  includeInverter,
  selectedZone,
  marketMult
}) {
  const [viewMode, setViewMode] = useState('pnl');
  const [showRevDetail, setShowRevDetail] = useState(false);
  const [showOpexDetail, setShowOpexDetail] = useState(false);
  const pnl = D.pnl_25yr;
  const ref = pnl.reference_case;
  const grid = D.irr_grid;
  const zr = zoneRates(selectedZone, marketMult);
  const yieldScale = sy / ref.specific_yield;
  const rateRef = ref.tariff_mix_2td * grid.eff_rate_2td + (1 - ref.tariff_mix_2td) * grid.eff_rate_3td;
  const rateIndexed = mix2td * zr.eff_rate_2td + (1 - mix2td) * zr.eff_rate_3td;
  const rateCurrent = revenueMode === 'indexed' ? rateIndexed : 0.070;
  const rateScale = rateCurrent / rateRef;
  const autoScale = autoconsumo / ref.autoconsumo_ratio;
  const poolScale = poolPrice / ref.surplus_compensation_price;
  const surplusRatioRef = 1 - ref.autoconsumo_ratio;
  const surplusRatioCur = 1 - autoconsumo;
  const capex = pnl.summary.total_capex;
  const kwp = D.metadata.reference_kwp;
  const inverterCost = kwp * 60;
  const scaledData = pnl.years.map((yr, i) => {
    const revPPA = pnl.revenue_ppa[i] * yieldScale * rateScale * autoScale;
    const revSurplus = pnl.revenue_surplus[i] * yieldScale * (surplusRatioCur / surplusRatioRef) * poolScale;
    const revGross = revPPA / D.tariff.discount_factor;
    const revDiscount = revGross - revPPA;
    const revTotal = revPPA + revSurplus;
    const opex = pnl.total_opex[i];
    const ebitda = revTotal - opex;
    const depr = pnl.depreciation[i];
    const taxable = Math.max(0, ebitda - depr);
    const tax = includeTax ? taxable * 0.25 : 0;
    const sustCapex = includeInverter ? pnl.sustaining_capex[i] : 0;
    const netCF = ebitda - tax - sustCapex;
    return {
      year: yr,
      revenue: Math.round(revTotal),
      revPPA: Math.round(revPPA),
      revGross: Math.round(revGross),
      revDiscount: Math.round(revDiscount),
      revSurplus: Math.round(revSurplus),
      opex: Math.round(opex),
      opexMaint: Math.round(pnl.cost_maintenance[i]),
      opexIns: Math.round(pnl.cost_insurance[i]),
      opexRent: Math.round(pnl.cost_rent[i]),
      ebitda: Math.round(ebitda),
      tax: Math.round(tax),
      sustCapex: Math.round(sustCapex),
      netCF: Math.round(netCF),
      depr: Math.round(depr)
    };
  });
  const cfVector = [-capex, ...scaledData.map(d => d.netCF)];
  const adjustedIRR = computeIRR(cfVector);
  let cumul = -capex;
  const cumulData = [{
    year: 0,
    cumCF: Math.round(-capex),
    netCF: Math.round(-capex)
  }];
  let paybackYr = null;
  scaledData.forEach(d => {
    cumul += d.netCF;
    cumulData.push({
      year: d.year,
      cumCF: Math.round(cumul),
      netCF: d.netCF
    });
    if (paybackYr === null && cumul > 0) paybackYr = d.year;
  });
  const totalCF = cumul;

  // Sync zero lines: compute shared domain so y=0 is at same position on both axes
  const pnlChartData = scaledData.map((d, i) => ({
    year: d.year,
    'PPA Revenue': d.revPPA,
    'Surplus': d.revSurplus,
    'OpEx': -d.opex,
    'Tax': -d.tax,
    'Net CF': d.netCF,
    'Cumulative': cumulData[i + 1].cumCF
  }));

  // For synced zero: find min/max of both series, align zero proportionally
  const cfValues = pnlChartData.flatMap(d => [d['PPA Revenue'] + d['Surplus'] + d['OpEx'] + d['Tax'], d['Net CF']]);
  const cumValues = cumulData.map(d => d.cumCF);
  const cfMin = Math.min(0, ...cfValues);
  const cfMax = Math.max(0, ...cfValues);
  const cumMin = Math.min(0, ...cumValues);
  const cumMax = Math.max(0, ...cumValues);
  // Ratio of negative space: make it equal on both axes
  const cfRatio = cfMin !== 0 ? Math.abs(cfMin) / (cfMax - cfMin) : 0;
  const cumRange = cumMax - cumMin;
  const targetCumMin = cumRange > 0 ? -(cfRatio / (1 - cfRatio)) * cumMax : cumMin;
  const targetCumMax = cumRange > 0 ? 1 - cfRatio > 0 ? cumMax : cumMax : cumMax;
  // Simpler approach: extend the axis with more negative space to match the other
  const cfNegFrac = cfMax > 0 ? Math.abs(cfMin) / cfMax : 1;
  const cumNegFrac = cumMax > 0 ? Math.abs(cumMin) / cumMax : 1;
  const maxNegFrac = Math.max(cfNegFrac, cumNegFrac);
  const syncedCfDomain = [Math.round(-maxNegFrac * cfMax), Math.round(cfMax * 1.05)];
  const syncedCumDomain = [Math.round(-maxNegFrac * cumMax), Math.round(cumMax * 1.05)];

  // CF view data
  const cfChartData = cumulData.map(d => ({
    year: d.year,
    'Net CF': d.netCF,
    'Cumulative': d.cumCF
  }));
  const cfViewValues = cfChartData.map(d => d['Net CF']);
  const cfViewCumValues = cfChartData.map(d => d['Cumulative']);
  const cfvMin = Math.min(0, ...cfViewValues);
  const cfvMax = Math.max(0, ...cfViewValues);
  const cfvCumMin = Math.min(0, ...cfViewCumValues);
  const cfvCumMax = Math.max(0, ...cfViewCumValues);
  const cfvNegFrac = cfvMax > 0 ? Math.abs(cfvMin) / cfvMax : 1;
  const cfvCumNegFrac = cfvCumMax > 0 ? Math.abs(cfvCumMin) / cfvCumMax : 1;
  const cfvMaxNegFrac = Math.max(cfvNegFrac, cfvCumNegFrac);
  const syncedCfvDomain = [Math.round(-cfvMaxNegFrac * cfvMax), Math.round(cfvMax * 1.05)];
  const syncedCfvCumDomain = [Math.round(-cfvMaxNegFrac * cfvCumMax), Math.round(cfvCumMax * 1.05)];

  // Table rows — Revenue PPA and OpEx are expandable
  const tableRows = [];
  // Revenue PPA (expandable)
  tableRows.push({ label: 'Revenue PPA', key: 'revPPA', cls: 'text-emerald-400', expandKey: 'rev' });
  if (showRevDetail) {
    tableRows.push({ label: 'Gross retail (peaje+energ\u00EDa+cargo)', key: 'revGross', cls: 'text-gray-500', child: true });
    tableRows.push({ label: '\u221215% discount', key: 'revDiscount', cls: 'text-red-400/60', neg: true, child: true });
  }
  // Surplus (plain)
  tableRows.push({ label: 'Surplus compensation', key: 'revSurplus', cls: 'text-purple-400' });
  // Total revenue (bold, not expandable)
  tableRows.push({ label: 'Total revenue', key: 'revenue', cls: 'text-gray-200 font-semibold', bold: true });
  // OpEx (expandable)
  tableRows.push({ label: 'OpEx', key: 'opex', cls: 'text-red-400', neg: true, expandKey: 'opex' });
  if (showOpexDetail) {
    tableRows.push({ label: 'Maintenance', key: 'opexMaint', cls: 'text-gray-500', neg: true, child: true });
    tableRows.push({ label: 'Insurance', key: 'opexIns', cls: 'text-gray-500', neg: true, child: true });
    tableRows.push({ label: 'Rent / land lease', key: 'opexRent', cls: 'text-gray-500', neg: true, child: true });
  }
  // EBITDA
  tableRows.push({ label: 'EBITDA', key: 'ebitda', cls: 'text-gray-200 font-semibold', bold: true });
  // Tax
  tableRows.push({ label: 'Tax', key: 'tax', cls: includeTax ? 'text-orange-400' : 'text-gray-600', neg: true });
  // Sust. CAPEX
  tableRows.push({ label: 'Sust. CAPEX', key: 'sustCapex', cls: includeInverter ? 'text-red-300' : 'text-gray-600', neg: true });
  // Net CF
  tableRows.push({ label: 'Net CF', key: 'netCF', cls: 'text-amber-400 font-semibold', bold: true });
  return /*#__PURE__*/React.createElement("div", {
    className: "panel p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-1"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-semibold text-gray-300"
  }, "25-Year P&L + Cash Flows"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-1"
  }, /*#__PURE__*/React.createElement(ToggleButton, {
    label: "P&L",
    active: viewMode === 'pnl',
    onClick: () => setViewMode('pnl')
  }), /*#__PURE__*/React.createElement(ToggleButton, {
    label: "Cash Flow",
    active: viewMode === 'cf',
    onClick: () => setViewMode('cf')
  }))), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mb-3"
  }, viewMode === 'pnl' ? 'Annual P&L reactive to sliders. OpEx from project model.' : 'Cash flow: Y0 = \u2212CAPEX, Y1-25 = net operating CF.', !includeTax && ' Tax OFF.', !includeInverter && ' Inverter OFF.'), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 sm:grid-cols-5 gap-2 mb-3 text-xs"
  }, /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "CAPEX"), /*#__PURE__*/React.createElement("div", {
    className: "text-lg font-mono text-gray-300"
  }, fmtEur(capex, 0))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Y1 EBITDA"), /*#__PURE__*/React.createElement("div", {
    className: `text-lg font-mono ${scaledData[0].ebitda >= 0 ? 'text-emerald-400' : 'text-red-400'}`
  }, fmtEur(scaledData[0].ebitda, 0))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "Payback"), /*#__PURE__*/React.createElement("div", {
    className: `text-lg font-mono ${paybackYr && paybackYr <= 15 ? 'text-emerald-400' : paybackYr ? 'text-amber-400' : 'text-red-400'}`
  }, paybackYr ? `Yr ${paybackYr}` : 'Never')), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "25yr cumul."), /*#__PURE__*/React.createElement("div", {
    className: `text-lg font-mono ${totalCF >= 0 ? 'text-emerald-400' : 'text-red-400'}`
  }, fmtEur(totalCF, 0))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-800/50 p-2 rounded"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-gray-500"
  }, "IRR (adj.)"), /*#__PURE__*/React.createElement("div", {
    className: `text-lg font-mono ${adjustedIRR >= 0.04 ? 'text-emerald-400' : adjustedIRR >= 0 ? 'text-amber-400' : 'text-red-400'}`
  }, fmtPct(adjustedIRR)))), viewMode === 'pnl' ? /*#__PURE__*/React.createElement(ResponsiveContainer, {
    width: "100%",
    height: 240
  }, /*#__PURE__*/React.createElement(ComposedChart, {
    data: pnlChartData,
    margin: {
      left: 0,
      right: 10,
      top: 5,
      bottom: 0
    },
    stackOffset: "sign",
    barCategoryGap: "15%"
  }, /*#__PURE__*/React.createElement(CartesianGrid, {
    strokeDasharray: "3 3",
    stroke: "#2a2d35"
  }), /*#__PURE__*/React.createElement(XAxis, {
    dataKey: "year",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => v % 5 === 0 || v === 1 ? `Y${v}` : ''
  }), /*#__PURE__*/React.createElement(YAxis, {
    yAxisId: "cf",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => `€${(v / 1000).toFixed(0)}k`,
    domain: syncedCfDomain
  }), /*#__PURE__*/React.createElement(YAxis, {
    yAxisId: "cum",
    orientation: "right",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => `€${(v / 1000).toFixed(0)}k`,
    domain: syncedCumDomain
  }), /*#__PURE__*/React.createElement(Tooltip, {
    contentStyle: {
      background: '#1a1d24',
      border: '1px solid #2a2d35',
      fontSize: 11
    },
    formatter: v => fmtEur(v, 0)
  }), /*#__PURE__*/React.createElement(ReferenceLine, {
    yAxisId: "cf",
    y: 0,
    stroke: "#4b5563"
  }), /*#__PURE__*/React.createElement(Bar, {
    yAxisId: "cf",
    dataKey: "PPA Revenue",
    stackId: "a",
    fill: "#22c55e",
    fillOpacity: 0.7
  }), /*#__PURE__*/React.createElement(Bar, {
    yAxisId: "cf",
    dataKey: "Surplus",
    stackId: "a",
    fill: "#8b5cf6",
    fillOpacity: 0.7
  }), /*#__PURE__*/React.createElement(Bar, {
    yAxisId: "cf",
    dataKey: "OpEx",
    stackId: "a",
    fill: "#ef4444",
    fillOpacity: 0.5
  }), /*#__PURE__*/React.createElement(Bar, {
    yAxisId: "cf",
    dataKey: "Tax",
    stackId: "a",
    fill: "#f97316",
    fillOpacity: 0.4
  }), /*#__PURE__*/React.createElement(Line, {
    yAxisId: "cum",
    type: "monotone",
    dataKey: "Cumulative",
    stroke: "#f59e0b",
    strokeWidth: 2,
    dot: false
  }))) : /*#__PURE__*/React.createElement(ResponsiveContainer, {
    width: "100%",
    height: 240
  }, /*#__PURE__*/React.createElement(ComposedChart, {
    data: cfChartData,
    margin: {
      left: 0,
      right: 10,
      top: 5,
      bottom: 0
    },
    barCategoryGap: "10%"
  }, /*#__PURE__*/React.createElement(CartesianGrid, {
    strokeDasharray: "3 3",
    stroke: "#2a2d35"
  }), /*#__PURE__*/React.createElement(XAxis, {
    dataKey: "year",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => `Y${v}`
  }), /*#__PURE__*/React.createElement(YAxis, {
    yAxisId: "cf",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => `€${(v / 1000).toFixed(0)}k`,
    domain: syncedCfvDomain
  }), /*#__PURE__*/React.createElement(YAxis, {
    yAxisId: "cum",
    orientation: "right",
    tick: {
      fill: '#6b7280',
      fontSize: 9
    },
    tickFormatter: v => `€${(v / 1000).toFixed(0)}k`,
    domain: syncedCfvCumDomain
  }), /*#__PURE__*/React.createElement(Tooltip, {
    contentStyle: {
      background: '#1a1d24',
      border: '1px solid #2a2d35',
      fontSize: 11
    },
    formatter: v => fmtEur(v, 0)
  }), /*#__PURE__*/React.createElement(ReferenceLine, {
    yAxisId: "cf",
    y: 0,
    stroke: "#4b5563"
  }), /*#__PURE__*/React.createElement(Bar, {
    yAxisId: "cf",
    dataKey: "Net CF",
    radius: [2, 2, 0, 0]
  }, cfChartData.map((e, i) => /*#__PURE__*/React.createElement(Cell, {
    key: i,
    fill: e['Net CF'] >= 0 ? '#22c55e' : '#ef4444',
    fillOpacity: 0.7
  }))), /*#__PURE__*/React.createElement(Line, {
    yAxisId: "cum",
    type: "monotone",
    dataKey: "Cumulative",
    stroke: "#f59e0b",
    strokeWidth: 2,
    dot: false
  }))), /*#__PURE__*/React.createElement("div", {
    className: "mt-3 overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-xs"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    className: "text-gray-500 border-b border-gray-700"
  }, /*#__PURE__*/React.createElement("th", {
    className: "text-left py-1 px-1"
  }, "Line item"), [1, 5, 10, 15, 20, 25].map(y => /*#__PURE__*/React.createElement("th", {
    key: y,
    className: "text-right py-1 px-1 font-mono"
  }, "Y", y)))), /*#__PURE__*/React.createElement("tbody", null, tableRows.map((row, ri) => /*#__PURE__*/React.createElement("tr", {
    key: ri,
    className: `border-b border-gray-800/50 ${row.expandKey ? 'cursor-pointer hover:bg-gray-800/30' : ''}`,
    onClick: row.expandKey === 'rev' ? () => setShowRevDetail(!showRevDetail) : row.expandKey === 'opex' ? () => setShowOpexDetail(!showOpexDetail) : undefined
  }, /*#__PURE__*/React.createElement("td", {
    className: `py-1 px-1 ${row.child ? 'pl-5 text-gray-500 text-[10px]' : row.bold ? 'text-gray-200 font-semibold' : 'text-gray-400'}`
  }, row.expandKey ? /*#__PURE__*/React.createElement("span", null, (row.expandKey === 'rev' ? showRevDetail : showOpexDetail) ? '\u25BC' : '\u25B6', " ", row.label) : row.label), [1, 5, 10, 15, 20, 25].map(y => {
    const d = scaledData[y - 1];
    const val = d ? d[row.key] : 0;
    return /*#__PURE__*/React.createElement("td", {
      key: y,
      className: `py-1 px-1 text-right font-mono ${row.child ? 'text-[10px] ' : ''}${row.cls}`
    }, row.neg ? `(${fmt(val, 0)})` : fmt(val, 0));
  })))))), /*#__PURE__*/React.createElement("div", {
    className: "mt-2 text-xs text-gray-600"
  }, "Revenue scales with sliders. OpEx: 2%/yr, rent 1%/yr.", includeInverter && ` Inverter Y${pnl.years[pnl.sustaining_capex.findIndex(c => c > 0)] || 12} (€${Math.round(inverterCost).toLocaleString()}).`, includeTax && ' Tax: 25% on (EBITDA − SL depreciation).', !includeTax && !includeInverter && ' Tax and inverter OFF — matches original projection baseline.'));
}

// =====================================================================
// SCENARIO IRR HELPER — computes IRR from parameter overrides
// Used by tornado chart and any scenario analysis
// =====================================================================
function computeScenarioIRR(overrides) {
  var pnl = D.pnl_25yr;
  var ref = pnl.reference_case;
  var grid = D.irr_grid;
  var o = overrides || {};
  var _sy = o.sy != null ? o.sy : 1347;
  var _mix = o.mix2td != null ? o.mix2td : 0.01;
  var _auto = o.autoconsumo != null ? o.autoconsumo : 0.80;
  var _pool = o.poolPrice != null ? o.poolPrice : 0.030;
  var _mm = o.marketMult != null ? o.marketMult : 1.0;
  var _zone = o.selectedZone || 'mediterraneo';
  var _tax = o.includeTax !== false;
  var _inv = o.includeInverter !== false;
  var _mode = o.revenueMode || 'indexed';

  var zr = zoneRates(_zone, _mm);
  var yieldScale = _sy / ref.specific_yield;
  var rateRef = ref.tariff_mix_2td * grid.eff_rate_2td + (1 - ref.tariff_mix_2td) * grid.eff_rate_3td;
  var rateIdx = _mix * zr.eff_rate_2td + (1 - _mix) * zr.eff_rate_3td;
  var rateCur = _mode === 'indexed' ? rateIdx : 0.070;
  var rateScale = rateCur / rateRef;
  var autoScale = _auto / ref.autoconsumo_ratio;
  var poolScale = _pool / ref.surplus_compensation_price;
  var surpRatioRef = 1 - ref.autoconsumo_ratio;
  var surpRatioCur = 1 - _auto;

  var cfs = [-pnl.summary.total_capex];
  for (var i = 0; i < pnl.years.length; i++) {
    var revPPA = pnl.revenue_ppa[i] * yieldScale * rateScale * autoScale;
    var revSurplus = pnl.revenue_surplus[i] * yieldScale * (surpRatioCur / surpRatioRef) * poolScale;
    var ebitda = revPPA + revSurplus - pnl.total_opex[i];
    var taxable = Math.max(0, ebitda - pnl.depreciation[i]);
    var tax = _tax ? taxable * 0.25 : 0;
    var sustCapex = _inv ? pnl.sustaining_capex[i] : 0;
    cfs.push(ebitda - tax - sustCapex);
  }
  return computeIRR(cfs);
}

// =====================================================================
// PANEL 6a: SENSITIVITY TORNADO CHART
// Shows what IRR is most sensitive to
// =====================================================================
function DeterministicTornado({
  sy,
  mix2td,
  autoconsumo,
  poolPrice,
  revenueMode,
  includeTax,
  includeInverter,
  selectedZone,
  marketMult
}) {
  var base = {sy: sy, mix2td: mix2td, autoconsumo: autoconsumo, poolPrice: poolPrice,
    marketMult: marketMult, selectedZone: selectedZone, revenueMode: revenueMode,
    includeTax: includeTax, includeInverter: includeInverter};
  var baseIRR = computeScenarioIRR(base);

  // Define sensitivity variables with ±swing
  var sensitivities = [
    {
      label: 'Yield (kWh/kWp)',
      key: 'sy',
      lo: Math.round(sy * 0.85),
      hi: Math.round(sy * 1.15),
      loLabel: Math.round(sy * 0.85),
      hiLabel: Math.round(sy * 1.15)
    },
    {
      label: 'Autoconsumo',
      key: 'autoconsumo',
      lo: Math.max(0.30, autoconsumo - 0.15),
      hi: Math.min(0.98, autoconsumo + 0.15),
      loLabel: Math.round(Math.max(0.30, autoconsumo - 0.15) * 100) + '%',
      hiLabel: Math.round(Math.min(0.98, autoconsumo + 0.15) * 100) + '%'
    },
    {
      label: 'Market energy price',
      key: 'marketMult',
      lo: Math.max(0.70, marketMult - 0.15),
      hi: Math.min(1.30, marketMult + 0.15),
      loLabel: (marketMult - 0.15 >= 1 ? '+' : '') + Math.round((marketMult - 0.15 - 1) * 100) + '%',
      hiLabel: (marketMult + 0.15 >= 1 ? '+' : '') + Math.round((marketMult + 0.15 - 1) * 100) + '%'
    },
    {
      label: 'Pool price (surplus)',
      key: 'poolPrice',
      lo: Math.max(0.01, poolPrice - 0.015),
      hi: Math.min(0.15, poolPrice + 0.015),
      loLabel: '€' + Math.max(0.01, poolPrice - 0.015).toFixed(3),
      hiLabel: '€' + Math.min(0.15, poolPrice + 0.015).toFixed(3)
    }
  ];

  // Compute IRR at low and high for each variable
  var bars = sensitivities.map(function(s) {
    var loOverride = Object.assign({}, base);
    loOverride[s.key] = s.lo;
    var hiOverride = Object.assign({}, base);
    hiOverride[s.key] = s.hi;
    var irrLo = computeScenarioIRR(loOverride);
    var irrHi = computeScenarioIRR(hiOverride);
    return {
      label: s.label,
      irrLo: Math.min(irrLo, irrHi),
      irrHi: Math.max(irrLo, irrHi),
      spread: Math.abs(irrHi - irrLo),
      loLabel: irrLo < irrHi ? s.loLabel : s.hiLabel,
      hiLabel: irrLo < irrHi ? s.hiLabel : s.loLabel
    };
  });

  // Sort by spread descending
  bars.sort(function(a, b) { return b.spread - a.spread; });

  // Chart dimensions
  var W = 500, H = 30 + bars.length * 40;
  var pad = {left: 120, right: 50, top: 10, bottom: 20};
  var chartW = W - pad.left - pad.right;

  // IRR range for x-axis
  var allVals = bars.reduce(function(acc, b) { return acc.concat([b.irrLo, b.irrHi]); }, [baseIRR]);
  var xMin = Math.min.apply(null, allVals) - 0.005;
  var xMax = Math.max.apply(null, allVals) + 0.005;
  var xScale = function(v) { return pad.left + (v - xMin) / (xMax - xMin) * chartW; };
  var baseX = xScale(baseIRR);

  return React.createElement("div", {className: "panel p-4"},
    React.createElement("h3", {className: "text-sm font-semibold text-gray-300 mb-1"},
      "Deterministic Sensitivity"),
    React.createElement("p", {className: "text-xs text-gray-500 mb-3"},
      "IRR sensitivity to \u00b115% swing on each variable (others held at current)"),
    React.createElement("svg", {width: W, height: H, className: "w-full", viewBox: '0 0 ' + W + ' ' + H},
      // Base case vertical line
      React.createElement("line", {
        x1: baseX, y1: pad.top, x2: baseX, y2: H - pad.bottom,
        stroke: "#f59e0b", strokeWidth: 1.5, strokeDasharray: "4,3"
      }),
      React.createElement("text", {
        x: baseX, y: H - 4, textAnchor: "middle", fill: "#f59e0b", fontSize: 9, fontFamily: "Arial"
      }, "Base " + (baseIRR * 100).toFixed(1) + "%"),
      // Bars
      bars.map(function(b, i) {
        var y = pad.top + i * 40 + 8;
        var x1 = xScale(b.irrLo);
        var x2 = xScale(b.irrHi);
        return React.createElement("g", {key: i},
          // Label
          React.createElement("text", {
            x: pad.left - 6, y: y + 12, textAnchor: "end",
            fill: "#9ca3af", fontSize: 10, fontFamily: "Arial"
          }, b.label),
          // Bar
          React.createElement("rect", {
            x: x1, y: y, width: Math.max(1, x2 - x1), height: 20,
            fill: "#3b82f6", opacity: 0.7, rx: 2
          }),
          // Low value label
          React.createElement("text", {
            x: x1 - 3, y: y + 14, textAnchor: "end",
            fill: "#6b7280", fontSize: 8, fontFamily: "Arial"
          }, (b.irrLo * 100).toFixed(1) + "%"),
          // High value label
          React.createElement("text", {
            x: x2 + 3, y: y + 14, textAnchor: "start",
            fill: "#6b7280", fontSize: 8, fontFamily: "Arial"
          }, (b.irrHi * 100).toFixed(1) + "%"),
          // Input value labels
          React.createElement("text", {
            x: x1 - 3, y: y + 24, textAnchor: "end",
            fill: "#4b5563", fontSize: 7, fontFamily: "Arial"
          }, b.loLabel),
          React.createElement("text", {
            x: x2 + 3, y: y + 24, textAnchor: "start",
            fill: "#4b5563", fontSize: 7, fontFamily: "Arial"
          }, b.hiLabel)
        );
      })
    )
  );
}

// =====================================================================
// PANEL 7: CONFIDENCE DASHBOARD (restored compact original + sorting)
// =====================================================================
function PanelConfidence() {
  const params = D.parameters;
  const [sortBy, setSortBy] = useState('confidence');
  const sorted = useMemo(() => {
    const confOrder = {
      low: 0,
      medium: 1,
      high: 2
    };
    const sensOrder = {
      high: 0,
      medium: 1,
      low: 2,
      pending: 3
    };
    return [...params].sort((a, b) => {
      if (sortBy === 'confidence') return (confOrder[a.confidence] || 3) - (confOrder[b.confidence] || 3);
      if (sortBy === 'sensitivity') return (sensOrder[a.sensitivity] || 3) - (sensOrder[b.sensitivity] || 3);
      return a.id.localeCompare(b.id);
    });
  }, [params, sortBy]);
  const confIcon = c => c === 'high' ? '🟢' : c === 'medium' ? '🟡' : '🔴';
  const redCount = params.filter(p => p.confidence === 'low').length;
  const yellowCount = params.filter(p => p.confidence === 'medium').length;
  const greenCount = params.filter(p => p.confidence === 'high').length;
  return /*#__PURE__*/React.createElement("div", {
    className: "panel p-4"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "text-sm font-semibold text-gray-300 mb-1"
  }, "Parameter Assumptions \u2014 Confidence Dashboard"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mb-3"
  }, "Parameter provenance: what's validated vs what's assumed"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 mb-3 text-xs"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-red-400"
  }, redCount, " \uD83D\uDD34 low"), /*#__PURE__*/React.createElement("span", {
    className: "text-amber-400"
  }, yellowCount, " \uD83D\uDFE1 medium"), /*#__PURE__*/React.createElement("span", {
    className: "text-emerald-400"
  }, greenCount, " \uD83D\uDFE2 high"), /*#__PURE__*/React.createElement("span", {
    className: "ml-auto text-gray-500"
  }, "Sort:", ['confidence', 'sensitivity', 'id'].map(s => /*#__PURE__*/React.createElement("button", {
    key: s,
    className: `ml-2 ${sortBy === s ? 'text-amber-400' : 'text-gray-500'}`,
    onClick: () => setSortBy(s)
  }, s)))), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "w-full text-xs"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", {
    className: "text-gray-500 border-b border-gray-700"
  }, /*#__PURE__*/React.createElement("th", {
    className: "text-left py-1 px-1"
  }, "ID"), /*#__PURE__*/React.createElement("th", {
    className: "text-left py-1 px-1"
  }, "Parameter"), /*#__PURE__*/React.createElement("th", {
    className: "text-right py-1 px-1"
  }, "Value"), /*#__PURE__*/React.createElement("th", {
    className: "text-center py-1 px-1"
  }, "Conf"), /*#__PURE__*/React.createElement("th", {
    className: "text-center py-1 px-1"
  }, "Sens"), /*#__PURE__*/React.createElement("th", {
    className: "text-left py-1 px-1"
  }, "Source"))), /*#__PURE__*/React.createElement("tbody", null, sorted.map(p => /*#__PURE__*/React.createElement("tr", {
    key: p.id,
    className: "border-b border-gray-800 hover:bg-gray-800/30"
  }, /*#__PURE__*/React.createElement("td", {
    className: "py-1.5 px-1 font-mono text-gray-500"
  }, p.id), /*#__PURE__*/React.createElement("td", {
    className: "py-1.5 px-1"
  }, p.name), /*#__PURE__*/React.createElement("td", {
    className: "py-1.5 px-1 text-right font-mono text-gray-300"
  }, typeof p.value === 'number' ? p.value < 1 && p.value > 0 ? p.value.toFixed(4) : fmt(p.value, 2) : p.value, p.unit ? /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600 ml-1"
  }, p.unit) : null), /*#__PURE__*/React.createElement("td", {
    className: "py-1.5 px-1 text-center"
  }, confIcon(p.confidence)), /*#__PURE__*/React.createElement("td", {
    className: `py-1.5 px-1 text-center font-mono ${p.sensitivity === 'high' ? 'text-red-400' : p.sensitivity === 'medium' ? 'text-amber-400' : 'text-gray-500'}`
  }, p.sensitivity?.toUpperCase()), /*#__PURE__*/React.createElement("td", {
    className: "py-1.5 px-1 text-gray-500 max-w-[200px] truncate"
  }, p.source)))))));
}


function MCDistribution() {
  const mc = D.monte_carlo;
  const irr = mc.irr;
  const hist = irr.histogram;
  const barData = hist.counts.map(function(c, i) {
    return {
      bin: ((hist.edges[i] + hist.edges[i+1]) / 2 * 100).toFixed(1),
      count: c,
      isP50: hist.edges[i] <= irr.p50 && irr.p50 < hist.edges[i+1]
    };
  });

  return React.createElement('div', {className: 'panel p-4'},
    React.createElement('div', {className: 'flex justify-between items-start mb-3'},
      React.createElement('div', null,
        React.createElement('div', {className: 'text-xs text-gray-500'}, 'Monte Carlo IRR Distribution'),
        React.createElement('div', {className: 'text-xs text-gray-600'}, mc.n_simulations + ' simulations')),
      React.createElement('div', {className: 'text-right'},
        React.createElement('div', {className: 'text-xs text-gray-500'}, 'P90 IRR (headline)'),
        React.createElement('div', {style: {color: irrColor(irr.p90), fontSize: '1.5rem', fontWeight: 'bold', fontFamily: 'monospace'}}, fmtPct(irr.p90)))),
    // Percentile badges
    React.createElement('div', {className: 'flex gap-3 mb-3'},
      ['p10','p25','p50','p75','p90'].map(function(k) {
        return React.createElement('div', {key:k, className: 'text-center flex-1'},
          React.createElement('div', {className: 'text-xs text-gray-500'}, k.toUpperCase()),
          React.createElement('div', {className: 'font-mono text-sm', style: {color: irrColor(irr[k])}}, fmtPct(irr[k])));
      })),
    // Histogram
    React.createElement(ResponsiveContainer, {width: '100%', height: 200},
      React.createElement(BarChart, {data: barData, margin: {top:5,right:5,bottom:5,left:5}},
        React.createElement(CartesianGrid, {strokeDasharray: '3 3', stroke: '#2a2d35'}),
        React.createElement(XAxis, {dataKey: 'bin', tick: {fontSize:10, fill:'#6b7280'}}),
        React.createElement(YAxis, {tick: {fontSize:10, fill:'#6b7280'}}),
        React.createElement(Tooltip, {contentStyle: {background:'#1a1d24', border:'1px solid #2a2d35'}, labelStyle: {color:'#f59e0b'}}),
        React.createElement(Bar, {dataKey: 'count', radius: [2,2,0,0]},
          barData.map(function(d,i) { return React.createElement(Cell, {key:i, fill: d.isP50 ? '#f59e0b' : '#374151'}); })))),
    // Probability badges
    React.createElement('div', {className: 'flex gap-4 mt-2 text-xs'},
      React.createElement('div', null,
        React.createElement('span', {className: 'text-gray-500'}, 'Pr(IRR<0): '),
        React.createElement('span', {className: 'font-mono text-red-400'}, fmtPct(mc.probabilities.irr_below_0, 1))),
      React.createElement('div', null,
        React.createElement('span', {className: 'text-gray-500'}, 'Pr(IRR<4%): '),
        React.createElement('span', {className: 'font-mono text-amber-400'}, fmtPct(mc.probabilities.irr_below_4pct, 1))),
      React.createElement('div', null,
        React.createElement('span', {className: 'text-gray-500'}, 'Pr(IRR>8%): '),
        React.createElement('span', {className: 'font-mono text-green-400'}, fmtPct(mc.probabilities.irr_above_8pct, 1))))
  );
}

// =====================================================================
// Cash Flow Fan Chart
// =====================================================================
function CFFanChart() {
  var fan = D.monte_carlo.cashflow_fan;
  var chartData = fan.years.map(function(y,i) {
    return { year: y, p10: fan.p10[i], p50: fan.p50[i], p90: fan.p90[i] };
  });

  return React.createElement('div', {className: 'panel p-4'},
    React.createElement('div', {className: 'text-xs text-gray-500 mb-2'}, 'Cash Flow Fan Chart (P10 / P50 / P90)'),
    React.createElement(ResponsiveContainer, {width: '100%', height: 250},
      React.createElement(ComposedChart, {data: chartData, margin: {top:5,right:20,bottom:5,left:20}},
        React.createElement(CartesianGrid, {strokeDasharray: '3 3', stroke: '#2a2d35'}),
        React.createElement(XAxis, {dataKey: 'year', tick: {fontSize:10, fill:'#6b7280'}}),
        React.createElement(YAxis, {tick: {fontSize:10, fill:'#6b7280'}, tickFormatter: function(v){return fmtEur(v);}}),
        React.createElement(Tooltip, {contentStyle: {background:'#1a1d24', border:'1px solid #2a2d35'}, formatter: function(v){return fmtEur(v);}}),
        React.createElement(Area, {dataKey: 'p90', stroke: 'none', fill: '#22c55e', fillOpacity: 0.15, name: 'P90'}),
        React.createElement(Area, {dataKey: 'p10', stroke: 'none', fill: '#0f1117', fillOpacity: 1, name: ''}),
        React.createElement(Line, {dataKey: 'p90', stroke: '#22c55e', strokeWidth: 1, dot: false, name: 'P90'}),
        React.createElement(Line, {dataKey: 'p50', stroke: '#f59e0b', strokeWidth: 2, dot: false, name: 'P50'}),
        React.createElement(Line, {dataKey: 'p10', stroke: '#ef4444', strokeWidth: 1, dot: false, name: 'P10'}),
        React.createElement(ReferenceLine, {y: 0, stroke: '#4b5563', strokeDasharray: '3 3'}),
        React.createElement(Legend, {wrapperStyle: {fontSize: 10}})
      ))
  );
}

// =====================================================================
// Sensitivity Tornado
// =====================================================================
function StochasticTornado() {
  var sens = D.sensitivity.slice(0, 8);
  var data = sens.map(function(s) {
    return {
      param: s.param.replace(/_/g, ' '),
      downside: +(s.delta_low * 100).toFixed(2),
      upside: +(s.delta_high * 100).toFixed(2),
      swing: s.total_swing
    };
  }).reverse();

  return React.createElement('div', {className: 'panel p-4'},
    React.createElement('div', {className: 'text-xs text-gray-500 mb-2'}, 'Sensitivity Tornado (top 8 drivers, IRR impact in pp)'),
    React.createElement(ResponsiveContainer, {width: '100%', height: 280},
      React.createElement(BarChart, {data: data, layout: 'vertical', margin: {top:5,right:20,bottom:5,left:130}},
        React.createElement(CartesianGrid, {strokeDasharray: '3 3', stroke: '#2a2d35'}),
        React.createElement(XAxis, {type: 'number', tick: {fontSize:10, fill:'#6b7280'}, tickFormatter: function(v){return v.toFixed(1)+'pp';}}),
        React.createElement(YAxis, {type: 'category', dataKey: 'param', tick: {fontSize:10, fill:'#9ca3af'}, width: 120}),
        React.createElement(Tooltip, {contentStyle: {background:'#1a1d24', border:'1px solid #2a2d35'}, formatter: function(v){return v.toFixed(2)+'pp';}}),
        React.createElement(ReferenceLine, {x: 0, stroke: '#4b5563'}),
        React.createElement(Bar, {dataKey: 'downside', fill: '#ef4444', name: 'Downside', radius: [2,0,0,2]}),
        React.createElement(Bar, {dataKey: 'upside', fill: '#22c55e', name: 'Upside', radius: [0,2,2,0]})))
  );
}


// =====================================================================
// Risk Register
// =====================================================================
function RiskRegister() {
  var rr = D.risk_register;
  var cats = [
    {key:'pre_cod', label:'Pre-COD', icon:'[1]'},
    {key:'operating', label:'Operating', icon:'[2]'},
    {key:'market_regulatory', label:'Market & Regulatory', icon:'[3]'},
    {key:'platform', label:'Platform', icon:'[4]'}
  ];

  var sections = cats.map(function(cat) {
    var risks = rr.categories[cat.key];
    if (!risks || risks.length === 0) return null;
    var riskEls = risks.map(function(r) {
      var es = r.evidence_status || (r.status === 'priced' ? 'quantified' : 'identified');
      var borderColor = es === 'evidenced' ? 'border-green-500' : es === 'quantified' ? 'border-amber-500' : 'border-gray-600';
      return React.createElement('div', {key: r.id, className: 'ml-2 mb-1 pl-2 py-1 text-xs border-l-2 ' + borderColor},
        React.createElement('div', {className: 'flex justify-between'},
          React.createElement('span', null,
            React.createElement('span', {className: 'text-gray-500 mr-1'}, r.id),
            React.createElement('span', {style: {color: riskTypeColor(r.type), cursor:'help'}, title: riskTypeLabel(r.type)}, riskTypeIcon(r.type) + ' '),
            React.createElement('span', {style: {color: riskTypeColor(r.type)}}, r.display_name)),
          React.createElement('span', {style: {color: evidenceColor(es), cursor:'help'}, title: evidenceLabel(es)}, evidenceIcon(es))),
        r.transmission && r.transmission.length > 0 ?
          React.createElement('div', {className: 'text-gray-600 mt-0.5'}, '→ ' + r.transmission.join(', ')) : null
      );
    });
    return React.createElement('div', {key: cat.key, className: 'mb-3'},
      React.createElement('div', {className: 'text-xs font-bold mb-1', style: {color: categoryColor(cat.key)}},
        cat.icon + ' ' + cat.label + ' (' + risks.length + ')'),
      riskEls);
  });

  return React.createElement('div', {className: 'panel p-4'},
    React.createElement('div', {className: 'mb-3'},
      React.createElement('div', {className: 'text-xs text-gray-500 mb-2'}, 'Risk Register — ' + rr.total_risks + ' risks'),
      // Legend: two collapsible sections
      React.createElement('div', {className: 'text-xs mb-2 px-2 py-1', style:{background:'#1a1d24', borderRadius:'4px'}},
        React.createElement('details', {className: 'mb-0.5'},
          React.createElement('summary', {className: 'text-gray-500 cursor-pointer select-none', style:{fontSize:'11px'}}, 'Risk type'),
          React.createElement('div', {className: 'pl-3 space-y-0.5 mt-0.5'},
            React.createElement('div', null, React.createElement('span', {style:{color:'#60a5fa'}}, '◆'), ' Quantifiable — modeled in MC with P10/P90 ranges'),
            React.createElement('div', null, React.createElement('span', {style:{color:'#f472b6'}}, '◇'), ' Structural — systematic, scenario analysis only'),
            React.createElement('div', null, React.createElement('span', {style:{color:'#a78bfa'}}, '○'), ' Operational — mitigated by contracts or processes'))),
        React.createElement('details', null,
          React.createElement('summary', {className: 'text-gray-500 cursor-pointer select-none', style:{fontSize:'11px'}}, 'Evidence status'),
          React.createElement('div', {className: 'pl-3 space-y-0.5 mt-0.5'},
            React.createElement('div', null, React.createElement('span', {style:{color:'#22c55e'}}, '●'), ' Evidenced — data room reference available'),
            React.createElement('div', null, React.createElement('span', {style:{color:'#f59e0b'}}, '◐'), ' Quantified — P10/P90 set, pending evidence'),
            React.createElement('div', null, React.createElement('span', {style:{color:'#6b7280'}}, '○'), ' Identified — named, not yet calibrated'))))),
    sections);
}

// =====================================================================
// Diversification Curve
// =====================================================================
function DiversificationCurve() {
  var curve = D.portfolio.diversification_curve;
  var chartData = curve.map(function(c) {
    return {
      n: c.n_projects,
      label: 'N=' + c.n_projects,
      p10: +(c.p10 * 100).toFixed(2),
      p50: +(c.p50 * 100).toFixed(2),
      p90: +(c.p90 * 100).toFixed(2),
      spread: +(c.spread_p10_p90 * 100).toFixed(2)
    };
  });

  var rows = chartData.map(function(d) {
    return React.createElement('tr', {key:d.n, className: 'border-b border-gray-800'},
      React.createElement('td', {className: 'py-1 px-2 text-right text-gray-400'}, d.n),
      React.createElement('td', {className: 'py-1 px-2 text-right font-mono text-red-400'}, d.p10.toFixed(2)+'%'),
      React.createElement('td', {className: 'py-1 px-2 text-right font-mono text-amber-400'}, d.p50.toFixed(2)+'%'),
      React.createElement('td', {className: 'py-1 px-2 text-right font-mono text-green-400'}, d.p90.toFixed(2)+'%'),
      React.createElement('td', {className: 'py-1 px-2 text-right font-mono text-gray-300'}, d.spread.toFixed(2)+'%'));
  });

  return React.createElement('div', {className: 'panel p-4'},
    React.createElement('div', {className: 'text-xs text-gray-500 mb-2'}, 'Portfolio Diversification Curve — P10/P50/P90 IRR by Portfolio Size'),
    React.createElement(ResponsiveContainer, {width: '100%', height: 300},
      React.createElement(ComposedChart, {data: chartData, margin: {top:5,right:20,bottom:25,left:20}},
        React.createElement(CartesianGrid, {strokeDasharray: '3 3', stroke: '#2a2d35'}),
        React.createElement(XAxis, {dataKey: 'label', tick: {fontSize:10, fill:'#6b7280'}}),
        React.createElement(YAxis, {tick: {fontSize:10, fill:'#6b7280'}, tickFormatter: function(v){return v.toFixed(0)+'%';}, domain: ['auto','auto']}),
        React.createElement(Tooltip, {contentStyle: {background:'#1a1d24', border:'1px solid #2a2d35'}, formatter: function(v){return v.toFixed(2)+'%';}}),
        React.createElement(Area, {dataKey: 'p90', stroke: 'none', fill: '#22c55e', fillOpacity: 0.1}),
        React.createElement(Area, {dataKey: 'p10', stroke: 'none', fill: '#0f1117', fillOpacity: 1}),
        React.createElement(Line, {dataKey: 'p90', stroke: '#22c55e', strokeWidth: 1.5, dot: true, name: 'P90'}),
        React.createElement(Line, {dataKey: 'p50', stroke: '#f59e0b', strokeWidth: 2, dot: true, name: 'P50'}),
        React.createElement(Line, {dataKey: 'p10', stroke: '#ef4444', strokeWidth: 1.5, dot: true, name: 'P10'}),
        React.createElement(Legend, {wrapperStyle: {fontSize: 10}}))),
    // Spread table
    React.createElement('div', {className: 'mt-2 overflow-x-auto'},
      React.createElement('table', {className: 'w-full text-xs'},
        React.createElement('thead', null,
          React.createElement('tr', {className: 'text-gray-500 border-b border-gray-700'},
            ['N', 'P10 IRR', 'P50 IRR', 'P90 IRR', 'Spread'].map(function(h) {
              return React.createElement('th', {key:h, className: 'py-1 px-2 text-right'}, h);
            }))),
        React.createElement('tbody', null, rows)))
  );
}

// =====================================================================
// Portfolio Summary Metrics
// =====================================================================
function PortfolioSummary() {
  var mc = D.monte_carlo;
  var curve = D.portfolio.diversification_curve;
  var n100 = curve.filter(function(c){return c.n_projects===100;})[0] || curve[curve.length-1];
  var n1 = curve.filter(function(c){return c.n_projects===1;})[0] || curve[0];
  var spreadReduction = n1.spread_p10_p90 > 0 ?
    ((1 - n100.spread_p10_p90 / n1.spread_p10_p90) * 100).toFixed(0) : '—';

  return React.createElement('div', {className: 'grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 mb-4'},
    React.createElement(MetricCard, {label: 'Single Project P50 IRR', value: fmtPct(mc.irr.p50), color: irrColor(mc.irr.p50), sub: 'Indexed mode'}),
    React.createElement(MetricCard, {label: 'Portfolio P50 IRR (N=' + n100.n_projects + ')', value: fmtPct(n100.p50), color: irrColor(n100.p50), sub: 'After diversification'}),
    React.createElement(MetricCard, {label: 'Spread Reduction', value: spreadReduction + '%', color: '#60a5fa', sub: 'N=1 → N=' + n100.n_projects}),
    React.createElement(MetricCard, {label: 'Portfolio P10-P90', value: fmtPct(n100.spread_p10_p90), color: '#a78bfa', sub: 'At N=' + n100.n_projects + ' projects'}));
}

// =====================================================================
// Risk Attribution
// =====================================================================
function RiskAttribution() {
  var sens = D.sensitivity.slice(0, 6);
  var total = sens.reduce(function(s,x){return s + x.total_swing;}, 0);
  var colors = ['#f59e0b','#60a5fa','#22c55e','#ef4444','#a78bfa','#f472b6'];
  var pieData = sens.map(function(s,i) {
    return {
      name: s.param.replace(/_/g, ' '),
      value: +((s.total_swing / total) * 100).toFixed(1),
      swing: s.total_swing,
      fill: colors[i] || '#6b7280'
    };
  });

  var legendItems = pieData.map(function(d,i) {
    return React.createElement('div', {key:i, className: 'flex items-center gap-2 text-xs'},
      React.createElement('div', {className: 'w-3 h-3 rounded', style: {background: d.fill}}),
      React.createElement('span', {className: 'text-gray-400 flex-1'}, d.name),
      React.createElement('span', {className: 'font-mono text-gray-300'}, fmtPct(d.swing) + ' swing'));
  });

  return React.createElement('div', {className: 'panel p-4'},
    React.createElement('div', {className: 'text-xs text-gray-500 mb-2'}, 'Risk Attribution — Share of IRR Variance'),
    React.createElement('div', {className: 'grid grid-cols-2 gap-4'},
      React.createElement(ResponsiveContainer, {width: '100%', height: 200},
        React.createElement(PieChart, null,
          React.createElement(Pie, {data: pieData, dataKey: 'value', nameKey: 'name', cx: '50%', cy: '50%',
            outerRadius: 80, innerRadius: 40, paddingAngle: 2},
            pieData.map(function(d,i) { return React.createElement(Cell, {key:i, fill:d.fill}); })),
          React.createElement(Tooltip, {contentStyle: {background:'#1a1d24', border:'1px solid #2a2d35'}}))),
      React.createElement('div', {className: 'space-y-2 pt-2'}, legendItems))
  );
}


// =====================================================================
// SCHEMATIC VIEW — "How Averta Works" (SVG flow diagram)
// =====================================================================
var _schTop = function(b) { return [b.x + b.w / 2, b.y]; };
var _schBot = function(b) { return [b.x + b.w / 2, b.y + b.h]; };
var _schLft = function(b) { return [b.x, b.y + b.h / 2]; };
var _schRgt = function(b) { return [b.x + b.w, b.y + b.h / 2]; };
var _schCx  = function(b) { return b.x + b.w / 2; };
var _schCy  = function(b) { return b.y + b.h / 2; };

function SchArr(_ref) {
  var from = _ref.from, to = _ref.to, color = _ref.color || '#6B7280';
  var x1 = from[0], y1 = from[1], x2 = to[0], y2 = to[1];
  var dx = x2 - x1, dy = y2 - y1;
  var len = Math.sqrt(dx * dx + dy * dy);
  if (len === 0) return null;
  var ux = dx / len, uy = dy / len, sz = 6;
  return React.createElement('g', null,
    React.createElement('line', { x1: x1, y1: y1, x2: x2 - ux * sz, y2: y2 - uy * sz, stroke: color, strokeWidth: 1.5 }),
    React.createElement('polygon', {
      points: x2 + ',' + y2 + ' ' + (x2 - ux * sz + uy * 3) + ',' + (y2 - uy * sz - ux * 3) + ' ' + (x2 - ux * sz - uy * 3) + ',' + (y2 - uy * sz + ux * 3),
      fill: color
    })
  );
}

function SchElbow(_ref) {
  var from = _ref.from, to = _ref.to, color = _ref.color || '#6B7280', midX = _ref.midX, midY = _ref.midY;
  var x1 = from[0], y1 = from[1], x2 = to[0], y2 = to[1];
  var pts;
  if (midX !== undefined) {
    pts = [[x1, y1], [midX, y1], [midX, y2], [x2, y2]];
  } else if (midY !== undefined) {
    pts = [[x1, y1], [x1, midY], [x2, midY], [x2, y2]];
  } else {
    var mx = (x1 + x2) / 2;
    pts = [[x1, y1], [mx, y1], [mx, y2], [x2, y2]];
  }
  var pathPts = pts.slice(0, -1);
  var lx1 = pts[pts.length - 2][0], ly1 = pts[pts.length - 2][1];
  var lx2 = pts[pts.length - 1][0], ly2 = pts[pts.length - 1][1];
  var dx = lx2 - lx1, dy = ly2 - ly1;
  var len = Math.sqrt(dx * dx + dy * dy);
  var ux = len > 0 ? dx / len : 0, uy = len > 0 ? dy / len : 0, sz = 6;
  var polyStr = pathPts.map(function(p) { return p.join(','); }).join(' ') + ' ' + (lx2 - ux * sz) + ',' + (ly2 - uy * sz);
  return React.createElement('g', null,
    React.createElement('polyline', { points: polyStr, fill: 'none', stroke: color, strokeWidth: 1.5 }),
    React.createElement('polygon', {
      points: lx2 + ',' + ly2 + ' ' + (lx2 - ux * sz + uy * 3) + ',' + (ly2 - uy * sz - ux * 3) + ' ' + (lx2 - ux * sz - uy * 3) + ',' + (ly2 - uy * sz + ux * 3),
      fill: color
    })
  );
}

function SchBox(_ref) {
  var b = _ref.b, stroke = _ref.stroke, label = _ref.label, value = _ref.value, sub = _ref.sub, labelColor = _ref.labelColor;
  var SC = { card: '#1A1D24', border: '#2A2D35', muted: '#6B7280', text: '#E5E7EB', dim: '#9CA3AF' };
  return React.createElement('g', null,
    React.createElement('rect', { x: b.x, y: b.y, width: b.w, height: b.h, rx: 6, fill: SC.card, stroke: stroke || SC.border, strokeWidth: 1.5 }),
    React.createElement('text', { x: b.x + b.w / 2, y: b.y + (value ? 18 : b.h / 2 + 4), textAnchor: 'middle', fill: labelColor || SC.dim, fontSize: 11, fontWeight: '600', fontFamily: 'Arial' }, label),
    value ? React.createElement('text', { x: b.x + b.w / 2, y: b.y + 36, textAnchor: 'middle', fill: SC.text, fontSize: 15, fontWeight: '700', fontFamily: 'monospace' }, value) : null,
    sub ? React.createElement('text', { x: b.x + b.w / 2, y: b.y + b.h - 8, textAnchor: 'middle', fill: SC.muted, fontSize: 9, fontFamily: 'Arial' }, sub) : null
  );
}

// Layout constants for schematic
var _DIV1 = 210, _DIV2 = 470, _DIV3 = 720;
var _COL1 = 100, _COL2 = (_DIV1 + _DIV2) / 2, _COL3 = (_DIV2 + _DIV3) / 2, _COL4 = (_DIV3 + 920) / 2;
var _SB = {
  panels:   { x: _COL1 - 80, y: 130, w: 160, h: 55 },
  yield:    { x: _COL1 - 80, y: 220, w: 160, h: 55 },
  annual:   { x: _COL1 - 80, y: 310, w: 160, h: 55 },
  selfCons: { x: 284, y: 148, w: 160, h: 60 },
  surplus:  { x: 284, y: 400, w: 160, h: 60 },
  formula:  { x: 490, y: 100, w: 220, h: 155 },
  surpComp: { x: 490, y: 390, w: 220, h: 80 },
  revenue:  { x: _COL4 - 87, y: 40, w: 175, h: 52 },
  ebitda:   { x: _COL4 - 87, y: 148, w: 175, h: 42 },
  netCf:    { x: _COL4 - 87, y: 238, w: 175, h: 42 },
  irrBox:   { x: _COL4 - 90, y: 310, w: 180, h: 100 },
  insight:  { x: _COL4 - 90, y: 430, w: 180, h: 70 }
};
var _SPL = { cx: 253, cy: 338, r: 16 };

function SchematicView(props) {
  var SC = { sun: '#F59E0B', panel: '#3B82F6', auto: '#22C55E', surplus: '#8B5CF6', opex: '#EF4444', tax: '#F97316', cash: '#10B981', bg: '#0F1117', card: '#1A1D24', border: '#2A2D35', muted: '#6B7280', text: '#E5E7EB', dim: '#9CA3AF' };
  var B = _SB, SPL = _SPL;

  // Live values from explorer state
  var kwp = D.metadata.reference_kwp;
  var zone = D.production.synthetic_zones[props.selectedZone] || {};
  var rawYield = zone.annual_yield_per_kwp || 1585;
  var adjYield = props.sy;
  var annualKwh = Math.round(kwp * adjYield);
  var selfKwh = Math.round(annualKwh * props.autoconsumo);
  var surplusKwh = annualKwh - selfKwh;
  var autoPct = Math.round(props.autoconsumo * 100);
  var surpPct = 100 - autoPct;

  // Effective rate computation (mirrors App) — zone-specific
  var grid = D.irr_grid;
  var zr = zoneRates(props.selectedZone, props.marketMult);
  var effRate3td = zr.eff_rate_3td;
  var effRate2td = zr.eff_rate_2td;
  var effRateIndexed = props.mix2td * effRate2td + (1 - props.mix2td) * effRate3td;
  var effRateBlended = 0.070;
  var effRate = props.revenueMode === 'indexed' ? effRateIndexed : effRateBlended;

  // Revenue Year 1
  var revAuto = Math.round(selfKwh * effRate);
  var revSurplus = Math.round(surplusKwh * props.poolPrice);
  var revTotal = revAuto + revSurplus;

  // P&L Year 1
  var pnl = D.pnl_25yr;
  var yieldScale = adjYield / pnl.reference_case.specific_yield;
  var opexY1 = Math.round(pnl.total_opex[0]);
  var ebitda = revTotal - opexY1;
  var deprecY1 = pnl.depreciation[0];
  var taxable = Math.max(0, ebitda - deprecY1);
  var taxAmt = props.includeTax ? Math.round(taxable * 0.25) : 0;
  var netCf = ebitda - taxAmt;
  var capex = Math.round(pnl.summary.total_capex);

  // Discount factor and pre-IE rate
  var discFactor = D.tariff.discount_factor;
  var preIE = effRate / discFactor;

  // Tariff block averages (solar-weighted 3.0TD)
  var t30 = D.tariff.prices_2026['30TD'];
  var solHrs = D.tariff.calendar_summary['30TD'].solar_hours_per_period;
  var totSolHrs = solHrs.reduce(function(a, b) { return a + b; }, 0);
  var wAvgPeaje = solHrs.reduce(function(s, h, i) { return s + h * t30.peaje[i]; }, 0) / totSolHrs;
  var wAvgCargo = solHrs.reduce(function(s, h, i) { return s + h * t30.cargo[i]; }, 0) / totSolHrs;
  var wAvgMarket = solHrs.reduce(function(s, h, i) { return s + h * t30.market[i]; }, 0) / totSolHrs;

  var fE = function(v) { return '\u20AC' + v.toLocaleString(); };
  var fK = function(v) { return Math.round(v / 1000) + 'k kWh'; };

  return React.createElement('div', { style: { padding: '0 8px' } },
    React.createElement('svg', { viewBox: '0 0 920 520', style: { width: '100%', background: SC.bg } },
      // Section labels
      React.createElement('text', { x: _COL1, y: 18, fill: SC.sun, fontSize: 10, fontWeight: '700', fontFamily: 'Arial', letterSpacing: '1.5', textAnchor: 'middle' }, 'PRODUCTION'),
      React.createElement('text', { x: _COL2, y: 18, fill: SC.auto, fontSize: 10, fontWeight: '700', fontFamily: 'Arial', letterSpacing: '1.5', textAnchor: 'middle' }, 'COMMERCIAL SPLIT'),
      React.createElement('text', { x: _COL3, y: 18, fill: SC.panel, fontSize: 10, fontWeight: '700', fontFamily: 'Arial', letterSpacing: '1.5', textAnchor: 'middle' }, 'PRICING MECHANISM'),
      React.createElement('text', { x: _COL4, y: 18, fill: SC.cash, fontSize: 10, fontWeight: '700', fontFamily: 'Arial', letterSpacing: '1.5', textAnchor: 'middle' }, 'FINANCIAL CASCADE'),

      // Dividers
      React.createElement('line', { x1: _DIV1, y1: 28, x2: _DIV1, y2: 500, stroke: SC.border, strokeWidth: 1, strokeDasharray: '4 4' }),
      React.createElement('line', { x1: _DIV2, y1: 28, x2: _DIV2, y2: 500, stroke: SC.border, strokeWidth: 1, strokeDasharray: '4 4' }),
      React.createElement('line', { x1: _DIV3, y1: 28, x2: _DIV3, y2: 500, stroke: SC.border, strokeWidth: 1, strokeDasharray: '4 4' }),

      // COL 1: PRODUCTION
      React.createElement('circle', { cx: _COL1, cy: 70, r: 24, fill: 'none', stroke: SC.sun, strokeWidth: 2 }),
      React.createElement('text', { x: _COL1, y: 76, textAnchor: 'middle', fill: SC.sun, fontSize: 24 }, '\u2600'),
      React.createElement(SchArr, { from: [_COL1, 94], to: _schTop(B.panels), color: SC.sun }),
      React.createElement(SchBox, { b: B.panels, label: 'Solar Panels', value: kwp + ' kWp', sub: 'rooftop installation', stroke: SC.panel, labelColor: SC.panel }),
      React.createElement(SchArr, { from: _schBot(B.panels), to: _schTop(B.yield), color: SC.panel }),
      React.createElement(SchBox, { b: B.yield, label: props.pvgisAdjust ? 'PVGIS \u00D70.85 yield' : 'PVGIS raw yield', value: adjYield + ' kWh/kWp', sub: props.pvgisAdjust ? 'raw ' + rawYield + ' \u2192 adjusted' : 'no adjustment', stroke: SC.sun, labelColor: SC.sun }),
      React.createElement(SchArr, { from: _schBot(B.yield), to: _schTop(B.annual), color: SC.dim }),
      React.createElement(SchBox, { b: B.annual, label: 'Annual production', value: fK(annualKwh), sub: kwp + ' \u00D7 ' + adjYield, stroke: SC.text, labelColor: SC.text }),
      React.createElement('text', { x: _COL1, y: 390, textAnchor: 'middle', fill: SC.muted, fontSize: 9, fontFamily: 'Arial' }, '\u22120.35%/yr degradation'),
      React.createElement('text', { x: _COL1, y: 402, textAnchor: 'middle', fill: SC.muted, fontSize: 9, fontFamily: 'Arial' }, 'over 25-year horizon'),

      // COL 2: COMMERCIAL SPLIT
      React.createElement(SchArr, { from: _schRgt(B.annual), to: [SPL.cx - SPL.r, SPL.cy], color: SC.dim }),
      React.createElement('circle', { cx: SPL.cx, cy: SPL.cy, r: SPL.r, fill: SC.card, stroke: SC.border, strokeWidth: 1.5 }),
      React.createElement('text', { x: SPL.cx, y: SPL.cy + 4, textAnchor: 'middle', fill: SC.text, fontSize: 10, fontWeight: '700' }, autoPct + '/' + surpPct),
      React.createElement(SchElbow, { from: [SPL.cx, SPL.cy - SPL.r], to: _schLft(B.selfCons), color: SC.auto, midY: _schCy(B.selfCons) }),
      React.createElement(SchBox, { b: B.selfCons, label: 'Self-consumed', value: fK(selfKwh), sub: autoPct + '% autoconsumo', stroke: SC.auto, labelColor: SC.auto }),
      React.createElement(SchElbow, { from: [SPL.cx, SPL.cy + SPL.r], to: _schLft(B.surplus), color: SC.surplus, midY: _schCy(B.surplus) }),
      React.createElement(SchBox, { b: B.surplus, label: 'Surplus \u2192 grid', value: fK(surplusKwh), sub: surpPct + '% injected', stroke: SC.surplus, labelColor: SC.surplus }),

      // COL 3: PRICING
      React.createElement(SchArr, { from: _schRgt(B.selfCons), to: [B.formula.x, _schCy(B.formula)], color: SC.auto }),

      // Averta pricing formula box
      React.createElement('rect', { x: B.formula.x, y: B.formula.y, width: B.formula.w, height: B.formula.h, rx: 8, fill: SC.card, stroke: SC.panel, strokeWidth: 2 }),
      React.createElement('text', { x: _schCx(B.formula), y: B.formula.y + 22, textAnchor: 'middle', fill: SC.panel, fontSize: 11, fontWeight: '700' },
        props.revenueMode === 'indexed' ? 'AVERTA PRICING FORMULA' : 'BLENDED FLAT RATE'),
      props.revenueMode === 'indexed' ?
        React.createElement('g', null,
          React.createElement('text', { x: B.formula.x + 20, y: B.formula.y + 48, fill: SC.dim, fontSize: 10, fontFamily: 'monospace' }, 'Peajes (network)  \u20AC' + wAvgPeaje.toFixed(4)),
          React.createElement('text', { x: B.formula.x + 20, y: B.formula.y + 63, fill: SC.dim, fontSize: 10, fontFamily: 'monospace' }, 'Energ\u00EDa (market)  \u20AC' + wAvgMarket.toFixed(4)),
          React.createElement('text', { x: B.formula.x + 20, y: B.formula.y + 78, fill: SC.dim, fontSize: 10, fontFamily: 'monospace' }, 'Cargos (system)   \u20AC' + wAvgCargo.toFixed(4)),
          React.createElement('line', { x1: B.formula.x + 20, y1: B.formula.y + 85, x2: B.formula.x + B.formula.w - 20, y2: B.formula.y + 85, stroke: SC.border, strokeWidth: 1 }),
          React.createElement('text', { x: B.formula.x + 20, y: B.formula.y + 100, fill: SC.text, fontSize: 10, fontFamily: 'monospace', fontWeight: '700' }, 'Pre-IE retail     \u20AC' + preIE.toFixed(4)),
          React.createElement('text', { x: B.formula.x + 20, y: B.formula.y + 118, fill: SC.sun, fontSize: 11, fontFamily: 'monospace', fontWeight: '700' }, '\u00D7 ' + discFactor + ' discount'),
          React.createElement('text', { x: B.formula.x + 20, y: B.formula.y + 138, fill: SC.auto, fontSize: 12, fontFamily: 'monospace', fontWeight: '700' }, '= Averta rate     \u20AC' + effRate.toFixed(4)),
          React.createElement('text', { x: _schCx(B.formula), y: B.formula.y + B.formula.h - 3, textAnchor: 'middle', fill: SC.muted, fontSize: 8 }, 'solar-weighted avg P1\u2013P6 (3.0TD) = \u20AC' + effRateIndexed.toFixed(4) + '/kWh')
        ) :
        React.createElement('g', null,
          React.createElement('text', { x: B.formula.x + 20, y: B.formula.y + 65, fill: SC.text, fontSize: 12, fontFamily: 'monospace', fontWeight: '700' }, 'Flat rate: \u20AC0.070/kWh'),
          React.createElement('text', { x: B.formula.x + 20, y: B.formula.y + 85, fill: SC.dim, fontSize: 10, fontFamily: 'monospace' }, 'Blended flat-rate assumption'),
          React.createElement('text', { x: B.formula.x + 20, y: B.formula.y + 105, fill: SC.dim, fontSize: 10, fontFamily: 'monospace' }, 'No period differentiation'),
          React.createElement('text', { x: _schCx(B.formula), y: B.formula.y + B.formula.h - 3, textAnchor: 'middle', fill: SC.muted, fontSize: 8 }, '\u20AC70/MWh blended all-in')
        ),

      // Surplus compensation
      React.createElement(SchArr, { from: _schRgt(B.surplus), to: [B.surpComp.x, _schCy(B.surpComp)], color: SC.surplus }),
      React.createElement('rect', { x: B.surpComp.x, y: B.surpComp.y, width: B.surpComp.w, height: B.surpComp.h, rx: 8, fill: SC.card, stroke: SC.surplus, strokeWidth: 1.5 }),
      React.createElement('text', { x: _schCx(B.surpComp), y: B.surpComp.y + 22, textAnchor: 'middle', fill: SC.surplus, fontSize: 11, fontWeight: '700' }, 'SURPLUS COMPENSATION'),
      React.createElement('text', { x: B.surpComp.x + 20, y: B.surpComp.y + 45, fill: SC.dim, fontSize: 10, fontFamily: 'monospace' }, 'Compensaci\u00F3n simplificada'),
      React.createElement('text', { x: B.surpComp.x + 20, y: B.surpComp.y + 62, fill: SC.surplus, fontSize: 11, fontFamily: 'monospace', fontWeight: '700' }, 'Pool rate: \u20AC' + props.poolPrice.toFixed(3) + '/kWh'),
      React.createElement('text', { x: _schCx(B.surpComp), y: B.surpComp.y + B.surpComp.h - 4, textAnchor: 'middle', fill: SC.muted, fontSize: 8 }, 'RD 244/2019 art. 14 \u2014 no IE, no peaje gen.'),

      // COL 4: FINANCIAL CASCADE
      React.createElement(SchElbow, { from: [B.formula.x + B.formula.w, _schCy(B.formula)], to: [B.revenue.x, _schCy(B.revenue) - 6], color: SC.auto, midX: B.formula.x + B.formula.w + 15 }),
      React.createElement(SchElbow, { from: [B.surpComp.x + B.surpComp.w, _schCy(B.surpComp)], to: [B.revenue.x, _schCy(B.revenue) + 6], color: SC.surplus, midX: B.surpComp.x + B.surpComp.w + 15 }),

      React.createElement(SchBox, { b: B.revenue, label: 'Total revenue', value: fE(revTotal), sub: fE(revAuto) + ' auto + ' + fE(revSurplus) + ' surplus', stroke: SC.auto, labelColor: SC.auto }),

      React.createElement('text', { x: _schCx(B.revenue), y: _schBot(B.revenue)[1] + 16, textAnchor: 'middle', fill: SC.opex, fontSize: 10, fontWeight: '700' }, '\u2212 OpEx ' + fE(opexY1)),
      React.createElement('text', { x: _schCx(B.revenue), y: _schBot(B.revenue)[1] + 28, textAnchor: 'middle', fill: SC.muted, fontSize: 8 }, 'maint + insurance + rent'),

      React.createElement(SchArr, { from: [_schCx(B.revenue), _schBot(B.revenue)[1] + 32], to: _schTop(B.ebitda), color: SC.dim }),
      React.createElement(SchBox, { b: B.ebitda, label: 'EBITDA', value: fE(ebitda), stroke: SC.text, labelColor: SC.text }),

      React.createElement('text', { x: _schCx(B.ebitda), y: _schBot(B.ebitda)[1] + 16, textAnchor: 'middle', fill: SC.tax, fontSize: 10, fontWeight: '700' },
        props.includeTax ? '\u2212 Tax ' + fE(taxAmt) : 'Tax: OFF'),
      React.createElement('text', { x: _schCx(B.ebitda), y: _schBot(B.ebitda)[1] + 28, textAnchor: 'middle', fill: SC.muted, fontSize: 8 },
        props.includeTax ? '25% \u00D7 max(0, EBITDA \u2212 depreciation)' : 'corporate tax excluded'),

      React.createElement(SchArr, { from: [_schCx(B.ebitda), _schBot(B.ebitda)[1] + 32], to: _schTop(B.netCf), color: SC.dim }),
      React.createElement(SchBox, { b: B.netCf, label: 'Net cash flow Y1', value: fE(netCf), stroke: SC.cash, labelColor: SC.cash }),

      React.createElement(SchArr, { from: _schBot(B.netCf), to: _schTop(B.irrBox), color: SC.cash }),

      // IRR box
      React.createElement('rect', { x: B.irrBox.x, y: B.irrBox.y, width: B.irrBox.w, height: B.irrBox.h, rx: 8, fill: SC.card, stroke: SC.cash, strokeWidth: 2 }),
      React.createElement('text', { x: _schCx(B.irrBox), y: B.irrBox.y + 22, textAnchor: 'middle', fill: SC.cash, fontSize: 11, fontWeight: '700' }, 'INVESTMENT RETURN'),
      React.createElement('text', { x: B.irrBox.x + 20, y: B.irrBox.y + 44, fill: SC.dim, fontSize: 10, fontFamily: 'monospace' }, 'CAPEX    ' + fE(capex)),
      React.createElement('text', { x: B.irrBox.x + 20, y: B.irrBox.y + 62, fill: SC.text, fontSize: 12, fontFamily: 'monospace', fontWeight: '700' }, 'IRR      ' + fmtPct(props.irr)),
      React.createElement('text', { x: B.irrBox.x + 20, y: B.irrBox.y + 80, fill: SC.text, fontSize: 10, fontFamily: 'monospace' }, 'Payback  ~' + (netCf > 0 ? Math.round(capex / netCf) : '??') + ' yr'),
      React.createElement('text', { x: _schCx(B.irrBox), y: B.irrBox.y + B.irrBox.h - 3, textAnchor: 'middle', fill: SC.muted, fontSize: 8 }, '25-year horizon, 100% equity'),

      // Insight box
      React.createElement('rect', { x: B.insight.x, y: B.insight.y, width: B.insight.w, height: B.insight.h, rx: 6, fill: '#1B2A4A', stroke: SC.panel, strokeWidth: 1 }),
      React.createElement('text', { x: _schCx(B.insight), y: B.insight.y + 20, textAnchor: 'middle', fill: SC.sun, fontSize: 10, fontWeight: '700' }, 'INVESTOR KEY INSIGHT'),
      React.createElement('text', { x: _schCx(B.insight), y: B.insight.y + 36, textAnchor: 'middle', fill: SC.text, fontSize: 9 }, 'Client saves ~20% on electricity'),
      React.createElement('text', { x: _schCx(B.insight), y: B.insight.y + 50, textAnchor: 'middle', fill: SC.text, fontSize: 9 }, '(15% discount + 5.11% IE waived)'),
      React.createElement('text', { x: _schCx(B.insight), y: B.insight.y + 64, textAnchor: 'middle', fill: SC.dim, fontSize: 8 }, 'Regulated tariff = guaranteed demand')
    ),

    // KPI strip
    React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginTop: 16 } },
      [
        { label: 'Client saving', value: '~20%', sub: '15% direct + 5.11% IE waived', color: SC.auto },
        { label: 'Effective rate', value: '\u20AC' + effRate.toFixed(3) + '/kWh', sub: props.revenueMode === 'indexed' ? 'solar-weighted 3.0TD \u00D7 ' + discFactor : 'flat blended rate', color: SC.panel },
        { label: 'Revenue visibility', value: '25 years', sub: 'regulated tariff structure', color: SC.sun },
        { label: 'Year 1 IRR', value: fmtPct(props.irr), sub: props.irr >= 0.04 ? 'above hurdle rate' : 'below hurdle rate', color: SC.cash }
      ].map(function(item, i) {
        return React.createElement('div', { key: i, style: { background: SC.card, borderRadius: 8, padding: '12px 14px', border: '1px solid ' + SC.border } },
          React.createElement('div', { style: { color: SC.muted, fontSize: 10, fontWeight: 600 } }, item.label),
          React.createElement('div', { style: { color: item.color, fontSize: 18, fontWeight: 700, fontFamily: 'monospace' } }, item.value),
          React.createElement('div', { style: { color: SC.muted, fontSize: 9 } }, item.sub)
        );
      })
    ),

    React.createElement('p', { style: { color: SC.muted, fontSize: 10, textAlign: 'center', marginTop: 16 } },
      'Live values from explorer sliders. ' + kwp + ' kWp, ' + props.selectedZone + ' zone, ' +
      (props.revenueMode === 'indexed' ? 'indexed pricing' : 'blended \u20AC70/MWh') +
      ', ' + autoPct + '% autoconsumo.')
  );
}



// =====================================================================
// TAB 1: PROJECT FUNDAMENTALS (interactive, wraps v2 panels)
// =====================================================================
function ProjectFundamentalsTab(props) {
  var sy = props.sy, setSy = props.setSy;
  var mix2td = props.mix2td, setMix2td = props.setMix2td;
  var autoconsumo = props.autoconsumo, setAutoconsumo = props.setAutoconsumo;
  var poolPrice = props.poolPrice, setPoolPrice = props.setPoolPrice;
  var selectedZone = props.selectedZone, setSelectedZone = props.setSelectedZone;
  var marketMult = props.marketMult, setMarketMult = props.setMarketMult;
  var includeTax = props.includeTax, setIncludeTax = props.setIncludeTax;
  var includeInverter = props.includeInverter, setIncludeInverter = props.setIncludeInverter;
  var pvgisAdjust = props.pvgisAdjust, setPvgisAdjust = props.setPvgisAdjust;
  var appIRR = props.appIRR;
  var revenueMode = props.revenueMode, setRevenueMode = props.setRevenueMode;

  var _viewState = useState('explorer');
  var viewMode = _viewState[0], setViewMode = _viewState[1];

  // Zone change handler
  function handleZoneChange(zone) {
    setSelectedZone(zone);
    var z = D.production.synthetic_zones[zone];
    if (z) {
      var adj = pvgisAdjust ? z.adjusted_yield_per_kwp : z.raw_yield_per_kwp;
      setSy(adj);
    }
  }

  function handlePvgisToggle() {
    var newVal = !pvgisAdjust;
    setPvgisAdjust(newVal);
    var z = D.production.synthetic_zones[selectedZone];
    if (z) {
      setSy(newVal ? z.adjusted_yield_per_kwp : z.raw_yield_per_kwp);
    }
  }

  function handleReset() {
    setSy(1347);
    setMix2td(0.01);
    setAutoconsumo(0.80);
    setPoolPrice(0.045);
    setSelectedZone('mediterraneo');
    setMarketMult(1.0);
    setIncludeTax(true);
    setIncludeInverter(true);
    setPvgisAdjust(true);
    setRevenueMode('indexed');
  }

  // Sub-tabs for explorer vs schematic
  var subTabBar = React.createElement('div', {className: 'flex gap-1 mb-3'},
    React.createElement('button', {
      className: 'text-xs px-3 py-1 rounded ' + (viewMode === 'explorer' ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : 'bg-gray-800 text-gray-500 border border-gray-700'),
      onClick: function(){ setViewMode('explorer'); }
    }, 'Explorer'),
    React.createElement('button', {
      className: 'text-xs px-3 py-1 rounded ' + (viewMode === 'schematic' ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : 'bg-gray-800 text-gray-500 border border-gray-700'),
      onClick: function(){ setViewMode('schematic'); }
    }, 'How it Works'));

  // Left sidebar with controls
  var sidebar = React.createElement('div', {className: 'md:col-span-3 space-y-3', style: {position: 'sticky', top: '1rem', alignSelf: 'start'}},
    // Zone selector
    React.createElement('div', {className: 'panel p-3'},
      React.createElement('div', {className: 'text-xs text-gray-500 mb-2 font-semibold'}, 'Climate Zone'),
      React.createElement(ZoneSelector, {zones: D.production.synthetic_zones, selected: selectedZone, onChange: handleZoneChange})),
    // Sliders
    React.createElement('div', {className: 'panel p-3'},
      React.createElement(Slider, {label: 'Specific Yield', value: sy, min: 600, max: 1900, step: 10, onChange: setSy, unit: 'kWh/kWp'}),
      React.createElement(Slider, {label: 'Tariff Mix (% 2.0TD)', value: mix2td, min: 0, max: 0.5, step: 0.01, onChange: setMix2td, format: function(v){return (v*100).toFixed(0)+'%';}}),
      React.createElement(Slider, {label: 'Autoconsumo', value: autoconsumo, min: 0.30, max: 0.98, step: 0.01, onChange: setAutoconsumo, format: function(v){return (v*100).toFixed(0)+'%';}}),
      React.createElement(Slider, {label: 'Pool Price (surplus)', value: poolPrice, min: 0.01, max: 0.15, step: 0.005, onChange: setPoolPrice, format: function(v){return 'EUR '+v.toFixed(3)+'/kWh';}}),
      React.createElement(Slider, {label: 'Market Energy Price', value: marketMult, min: 0.70, max: 1.30, step: 0.01, onChange: setMarketMult, format: function(v){return v.toFixed(2)+'x';}})),
    // IRR display
    React.createElement('div', {className: 'panel p-3 text-center'},
      React.createElement('div', {className: 'text-xs text-gray-500'}, 'Current IRR'),
      React.createElement('div', {className: 'text-2xl font-mono font-bold', style: {color: irrColor(appIRR)}}, fmtPct(appIRR)),
      React.createElement('div', {className: 'text-xs text-gray-600 mt-1'}, 'Unlevered, ' + (includeTax ? 'post-tax' : 'pre-tax'))),
    // Toggles
    React.createElement('div', {className: 'panel p-3 space-y-2'},
      React.createElement('div', {className: 'flex gap-1'},
        React.createElement(ToggleButton, {label: 'Indexed', active: revenueMode === 'indexed', onClick: function(){setRevenueMode('indexed');}}),
        React.createElement(ToggleButton, {label: 'Blended', active: revenueMode === 'blended', onClick: function(){setRevenueMode('blended');}})),
      React.createElement('label', {className: 'flex items-center gap-2 text-xs text-gray-400 cursor-pointer'},
        React.createElement('input', {type: 'checkbox', checked: includeTax, onChange: function(){setIncludeTax(!includeTax);}}),
        'Corporate Tax (25%)'),
      React.createElement('label', {className: 'flex items-center gap-2 text-xs text-gray-400 cursor-pointer'},
        React.createElement('input', {type: 'checkbox', checked: includeInverter, onChange: function(){setIncludeInverter(!includeInverter);}}),
        'Inverter Replacement (Y12)'),
      React.createElement('label', {className: 'flex items-center gap-2 text-xs text-gray-400 cursor-pointer'},
        React.createElement('input', {type: 'checkbox', checked: pvgisAdjust, onChange: handlePvgisToggle}),
        'PVGIS x0.85 adjustment')),
    // Info + Reset
    React.createElement('div', {className: 'panel p-3 text-xs text-gray-600 space-y-1'},
      React.createElement('div', null, 'CAPEX: ' + fmtEur(D.pnl_25yr.reference_case.capex_per_kwp * D.metadata.reference_kwp)),
      React.createElement('div', null, 'Discount: ' + (D.tariff.discount_factor * 100).toFixed(0) + '% of retail'),
      React.createElement('div', null, 'Horizon: ' + D.metadata.model_horizon_years + ' years'),
      React.createElement('button', {onClick: handleReset, className: 'mt-2 w-full text-xs px-2 py-1 rounded bg-gray-800 text-gray-500 border border-gray-700 hover:text-gray-300'}, 'Reset defaults')));

  // Explorer panels
  var explorerPanels = React.createElement('div', {className: 'md:col-span-9 space-y-4'},
    React.createElement(PanelProduction, {yield: sy, selectedZone: selectedZone, pvgisAdjust: pvgisAdjust}),
    React.createElement(PanelSumproduct, {mix2td: mix2td}),
    React.createElement(PanelRevenue, {sy: sy, mix2td: mix2td, autoconsumo: autoconsumo, poolPrice: poolPrice, revenueMode: revenueMode, selectedZone: selectedZone, marketMult: marketMult}),
    React.createElement(PanelPnL, {sy: sy, mix2td: mix2td, autoconsumo: autoconsumo, poolPrice: poolPrice, revenueMode: revenueMode, includeTax: includeTax, includeInverter: includeInverter, selectedZone: selectedZone, marketMult: marketMult}),
    React.createElement(DeterministicTornado, {sy: sy, mix2td: mix2td, autoconsumo: autoconsumo, poolPrice: poolPrice, revenueMode: revenueMode, includeTax: includeTax, includeInverter: includeInverter, selectedZone: selectedZone, marketMult: marketMult}),
    React.createElement(PanelConfidence, null));

  // Schematic view
  var schematicView = React.createElement('div', {className: 'col-span-12'},
    React.createElement(SchematicView, {sy: sy, selectedZone: selectedZone, pvgisAdjust: pvgisAdjust, mix2td: mix2td, autoconsumo: autoconsumo, poolPrice: poolPrice, marketMult: marketMult, revenueMode: revenueMode, includeTax: includeTax, includeInverter: includeInverter, irr: appIRR}));

  return React.createElement('div', null,
    subTabBar,
    React.createElement('div', {className: 'grid grid-cols-1 md:grid-cols-12 gap-4'},
      viewMode === 'explorer' ? sidebar : null,
      viewMode === 'explorer' ? explorerPanels : schematicView));
}

// =====================================================================
// TAB 2: RISK & RETURNS (read-only, stochastic)
// =====================================================================
function RiskReturnsTab() {
  var mc = D.monte_carlo;
  var irr = mc.irr;
  var pr = mc.probabilities;
  return React.createElement('div', null,
    // Top metrics — returns
    React.createElement('div', {className: 'grid grid-cols-3 sm:grid-cols-5 gap-2 sm:gap-3 mb-2'},
      React.createElement(MetricCard, {label: 'P10 IRR', value: fmtPct(irr.p10), color: irrColor(irr.p10), sub: 'Downside'}),
      React.createElement(MetricCard, {label: 'P50 IRR', value: fmtPct(irr.p50), color: irrColor(irr.p50), sub: 'Base case'}),
      React.createElement(MetricCard, {label: 'P90 IRR', value: fmtPct(irr.p90), color: irrColor(irr.p90), sub: 'Upside'}),
      React.createElement(MetricCard, {label: 'P50 NPV', value: fmtEur(mc.npv.p50), color: '#60a5fa', sub: 'Discounted'}),
      React.createElement(MetricCard, {label: 'Payback', value: mc.payback.p50 + ' yrs', color: '#a78bfa', sub: 'P50 median'})),
    // Hurdle probabilities
    React.createElement('div', {className: 'grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 mb-4'},
      React.createElement(MetricCard, {label: 'Pr(IRR < 0%)', value: fmtPct(pr.irr_below_0, 1), color: pr.irr_below_0 > 0.05 ? '#ef4444' : '#22c55e', sub: 'Capital loss'}),
      React.createElement(MetricCard, {label: 'Pr(IRR < 4%)', value: fmtPct(pr.irr_below_4pct, 1), color: pr.irr_below_4pct > 0.15 ? '#ef4444' : '#f59e0b', sub: 'Below cost of debt'}),
      React.createElement(MetricCard, {label: 'Pr(IRR > 8%)', value: fmtPct(pr.irr_above_8pct, 1), color: pr.irr_above_8pct > 0.7 ? '#22c55e' : '#f59e0b', sub: 'Above equity hurdle'}),
      React.createElement(MetricCard, {label: 'MC Simulations', value: mc.n_simulations.toString(), color: '#6b7280', sub: 'seed=' + mc.seed})),
    // Main layout
    React.createElement('div', {className: 'grid grid-cols-1 md:grid-cols-12 gap-4'},
      React.createElement('div', {className: 'md:col-span-3 space-y-4'},
        React.createElement(BankabilityBadge, null),
        React.createElement(RiskRegister, null)),
      React.createElement('div', {className: 'md:col-span-9 space-y-4'},
        React.createElement(MCDistribution, null),
        React.createElement(CFFanChart, null),
        React.createElement(StochasticTornado, null))));
}

// =====================================================================
// TAB 3: PORTFOLIO (read-only)
// =====================================================================
function CorrelationAssumptions() {
  var rows = [
    {type: 'Regional (weather/irradiance)', rho: '0.70', scope: 'Same province', risks: 'R-04 Production'},
    {type: 'Partial (consumer behavior)', rho: '0.20–0.40', scope: 'Economic cycle', risks: 'R-07 Churn, R-08 Autoconsumo, R-11 Settlement'},
    {type: 'Systematic (market/regulatory)', rho: '1.00', scope: 'All projects', risks: 'R-13 Tariff, R-14 Regulation, R-15 Pool, R-16 Rates'},
    {type: 'Independent (idiosyncratic)', rho: '0.00', scope: 'Per project', risks: 'R-02 EPC, R-05 Degradation, R-06 Equipment, R-10 Lease'}
  ];
  return React.createElement('div', {className: 'panel p-4'},
    React.createElement('div', {className: 'text-xs text-gray-500 mb-2'}, 'Correlation Structure — Assumptions Used in Portfolio Diversification'),
    React.createElement('div', {className: 'overflow-x-auto'},
      React.createElement('table', {className: 'w-full text-xs', style:{minWidth:'500px'}},
        React.createElement('thead', null,
          React.createElement('tr', {className: 'text-gray-500 border-b border-gray-700'},
            ['Correlation type', '\u03C1', 'Scope', 'Risks'].map(function(h) {
              return React.createElement('th', {key:h, className: 'py-1 px-2 text-left'}, h);
            }))),
        React.createElement('tbody', null,
          rows.map(function(r, i) {
            return React.createElement('tr', {key: i, className: 'border-b border-gray-800'},
              React.createElement('td', {className: 'py-1 px-2 text-gray-300'}, r.type),
              React.createElement('td', {className: 'py-1 px-2 font-mono text-gray-400'}, r.rho),
              React.createElement('td', {className: 'py-1 px-2 text-gray-500'}, r.scope),
              React.createElement('td', {className: 'py-1 px-2 text-gray-500'}, r.risks));
          })))),
    React.createElement('div', {className: 'text-xs text-gray-600 mt-2'},
      'Diversification benefit assumes inter-project correlations per category above. Systematic risks (regulatory, macro) do not diversify across the portfolio.'));
}

function DownsideImpactTable() {
  var sens = D.sensitivity.slice(0, 8);
  var baseIRR = D.sensitivity[0] ? D.sensitivity[0].irr_base : 0;
  var rows = sens.map(function(s) {
    return {
      param: s.param.replace(/_/g, ' '),
      downside_irr: s.irr_low,
      delta: s.delta_low,
      swing: s.total_swing
    };
  }).sort(function(a, b) { return a.delta - b.delta; });

  return React.createElement('div', {className: 'panel p-4'},
    React.createElement('div', {className: 'text-xs text-gray-500 mb-2'}, 'Downside Impact — Ranked by P10 IRR Effect'),
    React.createElement('div', {className: 'overflow-x-auto'},
      React.createElement('table', {className: 'w-full text-xs', style:{minWidth:'400px'}},
        React.createElement('thead', null,
          React.createElement('tr', {className: 'text-gray-500 border-b border-gray-700'},
            ['Parameter', 'Stressed IRR', 'Impact (pp)', 'Total swing'].map(function(h) {
              return React.createElement('th', {key:h, className: 'py-1 px-2 text-left'}, h);
            }))),
        React.createElement('tbody', null,
          rows.map(function(r, i) {
            var impactColor = r.delta < -0.03 ? 'text-red-400' : r.delta < -0.01 ? 'text-amber-400' : 'text-gray-400';
            return React.createElement('tr', {key: i, className: 'border-b border-gray-800'},
              React.createElement('td', {className: 'py-1 px-2 text-gray-300'}, r.param),
              React.createElement('td', {className: 'py-1 px-2 font-mono text-gray-300'}, fmtPct(r.downside_irr)),
              React.createElement('td', {className: 'py-1 px-2 font-mono ' + impactColor}, (r.delta * 100).toFixed(1) + 'pp'),
              React.createElement('td', {className: 'py-1 px-2 font-mono text-gray-500'}, (r.swing * 100).toFixed(1) + 'pp'));
          })))));
}



function KeyAssumptions() {
  var ref = D.pnl_25yr.reference_case;
  var mc = D.monte_carlo;
  var items = [
    {label: 'Specific yield (P50)', value: ref.specific_yield + ' kWh/kWp', note: 'Mediterráneo adjusted (PVGIS × 0.85)'},
    {label: 'Tariff mix', value: (ref.tariff_mix_2td * 100).toFixed(0) + '% 2.0TD / ' + ((1 - ref.tariff_mix_2td) * 100).toFixed(0) + '% 3.0TD', note: 'Confirmed: ~1% residential'},
    {label: 'Autoconsumo ratio', value: (ref.autoconsumo_ratio * 100).toFixed(0) + '%', note: 'Robert operational estimate'},
    {label: 'Discount factor', value: (ref.eff_rate * 100).toFixed(1) + '% eff. rate (F.I.)', note: '15% discount + 5.11% IEE'},
    {label: 'Surplus compensation', value: '€' + (ref.surplus_compensation_price * 1000).toFixed(0) + '/MWh', note: 'Compensación simplificada'},
    {label: 'CAPEX', value: '€' + ref.capex_per_kwp.toFixed(0) + '/kWp', note: '100% equity, no leverage'},
    {label: 'Tariff escalation', value: (ref.eff_rate_2td > 0 ? '2%/yr nominal' : '—'), note: 'Applied to retail tariff base'},
    {label: 'Degradation', value: '0.35%/yr', note: 'Manufacturer warranty (industry median 0.5%)'},
    {label: 'Regulatory scenarios', value: 'Peaje exemption maintained', note: 'Draft RD 2025 NOT modeled — treat as downside scenario'},
    {label: 'MC events', value: mc.events.specs.length + ' event types', note: 'Regulatory shock, macro stress, grid curtailment'}
  ];
  return React.createElement('div', {className: 'panel p-4 mt-4'},
    React.createElement('div', {className: 'text-xs text-gray-500 mb-2'}, 'Key Assumptions — Model Inputs Summary'),
    React.createElement('div', {className: 'grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-1'},
      items.map(function(it, i) {
        return React.createElement('div', {key: i, className: 'flex flex-col sm:flex-row justify-between text-xs border-b border-gray-800 py-1'},
          React.createElement('span', {className: 'text-gray-400'}, it.label),
          React.createElement('span', null,
            React.createElement('span', {className: 'font-mono text-gray-200 mr-2'}, it.value),
            React.createElement('span', {className: 'text-gray-600'}, it.note)));
      })));
}

function PortfolioTab() {
  return React.createElement('div', null,
    React.createElement(PortfolioSummary, null),
    React.createElement('div', {className: 'grid grid-cols-1 md:grid-cols-12 gap-4'},
      React.createElement('div', {className: 'md:col-span-7'},
        React.createElement(DiversificationCurve, null)),
      React.createElement('div', {className: 'md:col-span-5 space-y-4'},
        React.createElement(RiskAttribution, null),
        React.createElement(DownsideImpactTable, null))),
    React.createElement(CorrelationAssumptions, null),
    React.createElement(KeyAssumptions, null),
    React.createElement('div', {className: 'mt-4'},
      React.createElement(StochasticTornado, null)));
}

// =====================================================================
// APP — Three-tab layout with persistent header
// =====================================================================
function App() {
  var _tab = useState('fundamentals');
  var tab = _tab[0], setTab = _tab[1];

  // Tab 1 state
  var _sy = useState(1347);
  var sy = _sy[0], setSy = _sy[1];
  var _rm = useState('indexed');
  var revenueMode = _rm[0], setRevenueMode = _rm[1];
  var _mix = useState(0.01);
  var mix2td = _mix[0], setMix2td = _mix[1];
  var _auto = useState(0.80);
  var autoconsumo = _auto[0], setAutoconsumo = _auto[1];
  var _pool = useState(0.045);
  var poolPrice = _pool[0], setPoolPrice = _pool[1];
  var _zone = useState('mediterraneo');
  var selectedZone = _zone[0], setSelectedZone = _zone[1];
  var _mm = useState(1.0);
  var marketMult = _mm[0], setMarketMult = _mm[1];
  var _tax = useState(true);
  var includeTax = _tax[0], setIncludeTax = _tax[1];
  var _inv = useState(true);
  var includeInverter = _inv[0], setIncludeInverter = _inv[1];
  var _pvg = useState(true);
  var pvgisAdjust = _pvg[0], setPvgisAdjust = _pvg[1];

  // Compute IRR for Tab 1
  var appIRR = useMemo(function() {
    var ref = D.pnl_25yr;
    var yieldScale = sy / ref.reference_case.specific_yield;
    var rates = zoneRates(selectedZone, marketMult);
    var baseRate = ref.reference_case.eff_rate;
    var currentRate;
    if (revenueMode === 'blended') {
      currentRate = ref.reference_case.ppa_price_base / 1000;
    } else {
      currentRate = mix2td * rates.eff_rate_2td + (1 - mix2td) * rates.eff_rate_3td;
    }
    var rateScale = currentRate / baseRate;
    var autoScale = autoconsumo / ref.reference_case.autoconsumo_ratio;
    var poolScale = poolPrice / ref.reference_case.surplus_compensation_price;

    var capex = ref.reference_case.capex_per_kwp * D.metadata.reference_kwp;
    var cfs = [-capex];
    for (var i = 0; i < ref.years.length; i++) {
      var revPPA = ref.revenue_ppa[i] * yieldScale * rateScale * autoScale;
      var revSurplus = ref.revenue_surplus[i] * yieldScale * poolScale * ((1 - autoconsumo) / (1 - ref.reference_case.autoconsumo_ratio));
      var opex = ref.total_opex[i];
      var ebitda = revPPA + revSurplus - opex;
      var tax = includeTax ? Math.max(0, (ebitda - ref.depreciation[i]) * 0.25) : 0;
      var sustCapex = includeInverter ? ref.sustaining_capex[i] : 0;
      cfs.push(ebitda - tax - sustCapex);
    }
    return computeIRR(cfs);
  }, [sy, mix2td, autoconsumo, poolPrice, selectedZone, marketMult, revenueMode, includeTax, includeInverter]);

  // Header values (from MC, always static)
  var mc = D.monte_carlo;
  var rr = D.risk_register;
  var evScore = rr.evidence_coverage != null ? rr.evidence_coverage : rr.bankability_score;
  var bankColor = evScore >= 0.7 ? '#22c55e' : evScore >= 0.4 ? '#f59e0b' : '#ef4444';

  // Tab definitions
  var tabs = [
    {key: 'fundamentals', label: 'Project Fundamentals'},
    {key: 'risk', label: 'Risk & Returns'},
    {key: 'portfolio', label: 'Portfolio'}
  ];

  return React.createElement('div', {className: 'max-w-7xl mx-auto px-2 sm:px-4 py-4'},
    // Header
    React.createElement('div', {className: 'flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2'},
      React.createElement('div', null,
        React.createElement('h1', {className: 'text-lg sm:text-xl font-bold text-gray-100'}, 'Averta Project Explorer'),
        React.createElement('div', {className: 'text-xs text-gray-500'}, 'v4.0 — ' + D.metadata.build_date.split('T')[0])),
      React.createElement('div', {className: 'flex items-center gap-4 sm:gap-6'},
        React.createElement('div', {className: 'text-right'},
          React.createElement('div', {className: 'text-xs text-gray-500'}, 'P50 IRR'),
          React.createElement('div', {className: 'text-2xl font-mono font-bold', style: {color: irrColor(mc.irr.p50)}}, fmtPct(mc.irr.p50))),
        React.createElement('div', {className: 'text-right'},
          React.createElement('div', {className: 'text-xs text-gray-500'}, 'Evidence'),
          React.createElement('div', {className: 'text-2xl font-mono font-bold', style: {color: bankColor}},
            (evScore * 100).toFixed(0) + '%')))),

    // Tab bar
    React.createElement('div', {className: 'flex gap-1 mb-4 border-b border-gray-700'},
      tabs.map(function(t) {
        return React.createElement('button', {
          key: t.key,
          className: 'px-4 py-2 text-sm font-medium ' + (tab === t.key ? 'text-amber-400 border-b-2 border-amber-400' : 'text-gray-500 hover:text-gray-300'),
          onClick: function(){ setTab(t.key); }
        }, t.label);
      })),

    // Tab content
    tab === 'fundamentals' ? React.createElement(ProjectFundamentalsTab, {
      sy: sy, setSy: setSy,
      mix2td: mix2td, setMix2td: setMix2td,
      autoconsumo: autoconsumo, setAutoconsumo: setAutoconsumo,
      poolPrice: poolPrice, setPoolPrice: setPoolPrice,
      selectedZone: selectedZone, setSelectedZone: setSelectedZone,
      marketMult: marketMult, setMarketMult: setMarketMult,
      includeTax: includeTax, setIncludeTax: setIncludeTax,
      includeInverter: includeInverter, setIncludeInverter: setIncludeInverter,
      pvgisAdjust: pvgisAdjust, setPvgisAdjust: setPvgisAdjust,
      revenueMode: revenueMode, setRevenueMode: setRevenueMode,
      appIRR: appIRR
    }) :
    tab === 'risk' ? React.createElement(RiskReturnsTab, null) :
    React.createElement(PortfolioTab, null),

    // Footer
    React.createElement('div', {className: 'mt-4 text-xs text-gray-600 text-center'},
      'Averta Explorer \u2014 ' + rr.total_risks + ' risks tracked, ' + (rr.evidenced_count || 0) + ' evidenced, ' + (rr.quantified_count || 0) + ' quantified \u2014 ' + mc.n_simulations + ' MC simulations'));
}



try {
  ReactDOM.createRoot(document.getElementById('root')).render(
    React.createElement(App, null));
} catch(e) {
  document.getElementById('root').innerHTML =
    '<div style="padding:40px;color:#ef4444;font-family:monospace;background:#1a1d24;border-radius:8px;margin:20px;">' +
    '<h2 style="color:#f59e0b;">Averta Explorer v4 — Init Error</h2>' +
    '<pre>' + e.message + '\n' + e.stack + '</pre></div>';
}
</script>
</body>
</html>
